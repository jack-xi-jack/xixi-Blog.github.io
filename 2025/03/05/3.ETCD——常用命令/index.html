<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ETCD--常用命令 | 欢迎来到小熙的博客</title><meta name="author" content="小熙"><meta name="copyright" content="小熙"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="集群管理命令 ---  etcdctl是一个命令行的客户端，它提供了一些命令，可以方便我们在对服务进行测试或者手动修改数据库内容。etcdctl命令基本用法如下所示： 1etcdctl [global options] command [command options] [args...]   具体的命令选项参数可以通过 etcdctl command –help来获取相关帮助 环境变量 如果遇到">
<meta property="og:type" content="article">
<meta property="og:title" content="ETCD--常用命令">
<meta property="og:url" content="https://www.xiaoxi.ink/2025/03/05/3.ETCD%E2%80%94%E2%80%94%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/index.html">
<meta property="og:site_name" content="欢迎来到小熙的博客">
<meta property="og:description" content="集群管理命令 ---  etcdctl是一个命令行的客户端，它提供了一些命令，可以方便我们在对服务进行测试或者手动修改数据库内容。etcdctl命令基本用法如下所示： 1etcdctl [global options] command [command options] [args...]   具体的命令选项参数可以通过 etcdctl command –help来获取相关帮助 环境变量 如果遇到">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.xiaoxi.ink/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg">
<meta property="article:published_time" content="2025-03-05T11:08:06.000Z">
<meta property="article:modified_time" content="2025-03-30T13:04:26.864Z">
<meta property="article:author" content="小熙">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.xiaoxi.ink/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ETCD--常用命令",
  "url": "https://www.xiaoxi.ink/2025/03/05/3.ETCD%E2%80%94%E2%80%94%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/",
  "image": "https://www.xiaoxi.ink/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg",
  "datePublished": "2025-03-05T11:08:06.000Z",
  "dateModified": "2025-03-30T13:04:26.864Z",
  "author": [
    {
      "@type": "Person",
      "name": "小熙",
      "url": "https://www.xiaoxi.ink/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://www.xiaoxi.ink/2025/03/05/3.ETCD%E2%80%94%E2%80%94%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":150,"languages":{"author":"Author: 小熙","link":"Link: ","source":"Source: 欢迎来到小熙的博客","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ETCD--常用命令',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/xxx.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/background.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/%E5%A4%B4%E5%83%8F.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">34</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: 小屁股.jpg;"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">欢迎来到小熙的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">ETCD--常用命令</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">ETCD--常用命令</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-03-05T11:08:06.000Z" title="Created 2025-03-05 19:08:06">2025-03-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-03-30T13:04:26.864Z" title="Updated 2025-03-30 21:04:26">2025-03-30</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2025-03-30 21:04:26&quot;}" hidden></div><h2 id="dd367c2e"><font style="background-color:rgba(255, 255, 255, 0);">集群管理命令</font></h2>
---

<p><font style="background-color:rgba(255, 255, 255, 0);">etcdctl是一个</font><strong><font style="background-color:rgba(255, 255, 255, 0);">命令行的客户端</font></strong><font style="background-color:rgba(255, 255, 255, 0);">，它提供了一些命令，可以方便我们在对服务进行测试或者手动修改数据库内容。etcdctl命令基本用法如下所示：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl [global options] command [command options] [args...]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">具体的命令选项参数可以通过 etcdctl command –help来获取相关帮助</font></p>
<h3 id="3867e350"><font style="background-color:rgba(255, 255, 255, 0);">环境变量</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">如果遇到使用了TLS加密的集群，通常每条指令都需要指定证书路径和etcd节点地址，可以把相关命令行参数添加在环境变量中，在**~/.bashrc**添加以下内容：</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban etcd]# cat ~/.bashrc</span><br><span class="line">HOST_1=https://192.168.10.100:2379</span><br><span class="line">HOST_2=https://192.168.10.11:2379</span><br><span class="line">HOST_3=https://192.168.10.12:2379</span><br><span class="line">ENDPOINTS=$&#123;HOST_1&#125;,$&#123;HOST_2&#125;,$&#123;HOST_3&#125;</span><br><span class="line"># 如果需要使用原生命令，在命令开头加一个\ 例如：\etcdctl command</span><br><span class="line">alias etcdctl=&quot;etcdctl --endpoints=$&#123;ENDPOINTS&#125; --cacert=/root/cfssl/etcd/ca.pem --cert=/root/cfssl/etcd/client.pem --key=/root/cfssl/etcd/client-key.pem&quot;</span><br><span class="line">alias etcdctljson=&quot;etcdctl --endpoints=$&#123;ENDPOINTS&#125; --cacert=/root/cfssl/etcd/ca.pem --cert=/root/cfssl/etcd/client.pem --key=/root/cfssl/etcd/client-key.pem --write-out=json&quot;</span><br><span class="line">alias etcdctltable=&quot;etcdctl --endpoints=$&#123;ENDPOINTS&#125; --cacert=/root/cfssl/etcd/ca.pem --cert=/root/cfssl/etcd/client.pem --key=/root/cfssl/etcd/client-key.pem --write-out=table&quot;</span><br><span class="line">[root@tiaoban etcd]# source ~/.bashrc</span><br></pre></td></tr></table></figure>

<h3 id="c66c9b5d"><font style="background-color:rgba(255, 255, 255, 0);">查看etcd版本</font></h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban etcd]# etcdctl version</span><br><span class="line">etcdctl version: 3.4.23</span><br><span class="line">API version: 3.4</span><br></pre></td></tr></table></figure>

<h3 id="e65806ec"><font style="background-color:rgba(255, 255, 255, 0);">查看etcd集群节点信息</font></h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban ~]# etcdctl member list -w table</span><br><span class="line">+------------------+---------+-------+----------------------------+----------------------------+------------+</span><br><span class="line">|        ID        | STATUS  | NAME  |         PEER ADDRS         |        CLIENT ADDRS        | IS LEARNER |</span><br><span class="line">+------------------+---------+-------+----------------------------+----------------------------+------------+</span><br><span class="line">| 2e0eda3ad6bc6e1e | started | etcd1 | http://192.168.10.100:2380 | http://192.168.10.100:2379 |      false |</span><br><span class="line">| 5d2c1bd3b22f796f | started | etcd3 |  http://192.168.10.12:2380 |  http://192.168.10.12:2379 |      false |</span><br><span class="line">| bc34c6bd673bdf9f | started | etcd2 |  http://192.168.10.11:2380 |  http://192.168.10.11:2379 |      false |</span><br><span class="line">+------------------+---------+-------+----------------------------+----------------------------+------------+</span><br></pre></td></tr></table></figure>

<h3 id="bcf18e5c"><font style="background-color:rgba(255, 255, 255, 0);">查看集群健康状态</font></h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban ~]# etcdctl endpoint status -w table</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|      ENDPOINT       |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">| 192.168.10.100:2379 | 2e0eda3ad6bc6e1e |  3.4.23 |   20 kB |      true |      false |         4 |          9 |                  9 |        |</span><br><span class="line">|  192.168.10.11:2379 | bc34c6bd673bdf9f |  3.4.23 |   20 kB |     false |      false |         4 |          9 |                  9 |        |</span><br><span class="line">|  192.168.10.12:2379 | 5d2c1bd3b22f796f |  3.4.23 |   20 kB |     false |      false |         4 |          9 |                  9 |        |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">[root@tiaoban ~]# etcdctl endpoint health -w table</span><br><span class="line">+---------------------+--------+------------+-------+</span><br><span class="line">|      ENDPOINT       | HEALTH |    TOOK    | ERROR |</span><br><span class="line">+---------------------+--------+------------+-------+</span><br><span class="line">| 192.168.10.100:2379 |   true | 4.391924ms |       |</span><br><span class="line">|  192.168.10.11:2379 |   true | 7.091404ms |       |</span><br><span class="line">|  192.168.10.12:2379 |   true | 7.571706ms |       |</span><br><span class="line">+---------------------+--------+------------+-------+</span><br></pre></td></tr></table></figure>

<h3 id="cd2c454b"><font style="background-color:rgba(255, 255, 255, 0);">查看告警事件</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">如果内部出现问题，会触发告警，可以通过命令查看告警引起原因，命令如下所示：</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl alarm &lt;subcommand&gt; [flags]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">常用的子命令主要有两个：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 查看所有告警</span><br><span class="line">etcdctl alarm list</span><br><span class="line"># 解除所有告警</span><br><span class="line">etcdctl alarm disarm</span><br></pre></td></tr></table></figure>

<h3 id="c3514e94"><font style="background-color:rgba(255, 255, 255, 0);">添加成员</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">当集群部署完成后，后续可能需要进行节点扩缩容，就可以使用member命令管理节点。先查看当前集群信息</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban etcd]# etcdctl endpoint status --cluster -w table</span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|          ENDPOINT          |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">| http://192.168.10.100:2379 | 2e0eda3ad6bc6e1e |  3.4.23 |   20 kB |      true |      false |         8 |         16 |                 16 |        |</span><br><span class="line">|  http://192.168.10.12:2379 | 5d2c1bd3b22f796f |  3.4.23 |   20 kB |     false |      false |         8 |         16 |                 16 |        |</span><br><span class="line">|  http://192.168.10.11:2379 | bc34c6bd673bdf9f |  3.4.23 |   20 kB |     false |      false |         8 |         16 |                 16 |        |</span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">在启动新的etcd节点前，先向etcd集群声明添加节点的peer-urls和节点名称</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban etcd]# etcdctl member add etcd4 --peer-urls=http://192.168.10.100:12380</span><br><span class="line">Member b112a60ec305e42a added to cluster cd30cff36981306b</span><br><span class="line"></span><br><span class="line">ETCD_NAME=&quot;etcd4&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd1=http://192.168.10.100:2380,etcd3=http://192.168.10.12:2380,etcd4=http://192.168.10.100:12380,etcd2=http://192.168.10.11:2380&quot;</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;http://192.168.10.100:12380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;existing&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban etcd]# mkdir -p /opt/docker/etcd/&#123;conf,data&#125;</span><br><span class="line">[root@tiaoban etcd]# chown -R 1001:1001 /opt/docker/etcd/data/</span><br><span class="line">[root@tiaoban etcd]# cat /opt/docker/etcd/conf/etcd.conf </span><br><span class="line"># 节点名称</span><br><span class="line">name: &#x27;etcd4&#x27;</span><br><span class="line"># 指定节点的数据存储目录</span><br><span class="line">data-dir: &#x27;/data&#x27;</span><br><span class="line"># 监听客户端请求的地址列表</span><br><span class="line">listen-client-urls: &quot;http://192.168.10.100:12379&quot;</span><br><span class="line"># 监听URL，用于节点之间通信监听地址</span><br><span class="line">listen-peer-urls: &quot;http://192.168.10.100:12380&quot;</span><br><span class="line"># 对外公告的该节点客户端监听地址，这个值会告诉集群中其他节点</span><br><span class="line">advertise-client-urls: &quot;http://192.168.10.100:12379&quot;</span><br><span class="line"># 服务端之间通讯使用的地址列表,该节点同伴监听地址，这个值会告诉集群中其他节点</span><br><span class="line">initial-advertise-peer-urls: &quot;http://192.168.10.100:12380&quot;</span><br><span class="line"># etcd启动时，etcd集群的节点地址列表</span><br><span class="line">initial-cluster: &quot;etcd1=http://192.168.10.100:2380,etcd3=http://192.168.10.12:2380,etcd2=http://192.168.10.11:2380,etcd4=http://192.168.10.100:12380&quot;</span><br><span class="line"># etcd集群初始化的状态，new代表新建集群，existing表示加入现有集群</span><br><span class="line">initial-cluster-state: &#x27;existing&#x27;</span><br><span class="line">[root@tiaoban etcd]# docker run --name=etcd4 --net=host -d -v /opt/docker/etcd/data:/data -v /opt/docker/etcd/conf:/conf bitnami/etcd:latest etcd --config-file /conf/etcd.conf</span><br><span class="line">a142f38c785f2b7c217fb15f01ac62addfeb22eeb44da00363b1f7b5ce398439</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">etcd4启动后，查看集群节点信息：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban etcd]# etcdctl endpoint status --cluster -w table</span><br><span class="line">+-----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|          ENDPOINT           |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span><br><span class="line">+-----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|  http://192.168.10.100:2379 | 2e0eda3ad6bc6e1e |  3.4.23 |   20 kB |      true |      false |         6 |         11 |                 11 |        |</span><br><span class="line">|   http://192.168.10.12:2379 | 5d2c1bd3b22f796f |  3.4.23 |   20 kB |     false |      false |         6 |         11 |                 11 |        |</span><br><span class="line">| http://192.168.10.100:12379 | b112a60ec305e42a |  3.4.23 |   20 kB |     false |      false |         6 |         11 |                 11 |        |</span><br><span class="line">|   http://192.168.10.11:2379 | bc34c6bd673bdf9f |  3.4.23 |   20 kB |     false |      false |         6 |         11 |                 11 |        |</span><br><span class="line">+-----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br></pre></td></tr></table></figure>

<h3 id="8456c2a4"><font style="background-color:rgba(255, 255, 255, 0);">更新成员</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">当etcd节点故障，启动etcd时报错</font>`<font style="background-color:rgba(255, 255, 255, 0);">**member count is unequal**</font>`<font style="background-color:rgba(255, 255, 255, 0);">。如果有保留的数据目录下的文件时，可以通过使用 member update 命令，在保留 etcd 数据的情况下初始化集群数据，重新构建一个新的etcd集群节点。  
</font><font style="background-color:rgba(255, 255, 255, 0);">模拟192.168.10.100:12380节点故障，但数据目录文件有备份，启动一个新的节点，地址为：192.168.10.100:22380</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># 停用旧节点</span><br><span class="line">[root@tiaoban etcd]# docker stop etcd4</span><br><span class="line">etcd4</span><br><span class="line">[root@tiaoban etcd]# docker rm etcd4</span><br><span class="line">etcd4</span><br><span class="line"></span><br><span class="line"># 更新节点地址</span><br><span class="line">[root@tiaoban etcd]# cat conf/etcd.conf </span><br><span class="line"># 节点名称</span><br><span class="line">name: &#x27;etcd4&#x27;</span><br><span class="line"># 指定节点的数据存储目录</span><br><span class="line">data-dir: &#x27;/data&#x27;</span><br><span class="line"># 监听客户端请求的地址列表</span><br><span class="line">listen-client-urls: &quot;http://192.168.10.100:22379&quot;</span><br><span class="line"># 监听URL，用于节点之间通信监听地址</span><br><span class="line">listen-peer-urls: &quot;http://192.168.10.100:22380&quot;</span><br><span class="line"># 对外公告的该节点客户端监听地址，这个值会告诉集群中其他节点</span><br><span class="line">advertise-client-urls: &quot;http://192.168.10.100:22379&quot;</span><br><span class="line"># 服务端之间通讯使用的地址列表,该节点同伴监听地址，这个值会告诉集群中其他节点</span><br><span class="line">initial-advertise-peer-urls: &quot;http://192.168.10.100:22380&quot;</span><br><span class="line"># etcd启动时，etcd集群的节点地址列表</span><br><span class="line">initial-cluster: &quot;etcd1=http://192.168.10.100:2380,etcd2=http://192.168.10.11:2380,etcd3=http://192.168.10.12:2380,etcd4=http://192.168.10.100:22380&quot;</span><br><span class="line"># etcd集群初始化的状态，new代表新建集群，existing表示加入现有集群</span><br><span class="line">initial-cluster-state: &#x27;existing&#x27;</span><br><span class="line"></span><br><span class="line"># 启动新节点</span><br><span class="line">[root@tiaoban etcd]# docker run --name=etcd4 --net=host -d -v /opt/docker/etcd/data:/data -v /opt/docker/etcd/conf:/conf bitnami/etcd:3.4.23 etcd --config-file /conf/etcd.conf</span><br><span class="line">03c03ac7e6b50a8600cefe443ecafdb03f8f61f153b1a1138029c1726826d74e</span><br><span class="line">[root@tiaoban etcd]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE                 COMMAND                   CREATED         STATUS         PORTS     NAMES</span><br><span class="line">03c03ac7e6b5   bitnami/etcd:3.4.23   &quot;/opt/bitnami/script…&quot;   3 seconds ago   Up 3 seconds             etcd4</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">执行更新member操作，指定新的节点地址。</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban etcd]# etcdctl member update b112a60ec305e42a --peer-urls=http://192.168.10.100:22380</span><br><span class="line">Member b112a60ec305e42a updated in cluster cd30cff36981306b</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">查看集群节点信息，节点信息更新完成。</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban etcd]# etcdctl endpoint status --cluster -w table</span><br><span class="line">+-----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|          ENDPOINT           |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span><br><span class="line">+-----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|  http://192.168.10.100:2379 | 2e0eda3ad6bc6e1e |  3.4.23 |   20 kB |      true |      false |         6 |         14 |                 14 |        |</span><br><span class="line">|   http://192.168.10.12:2379 | 5d2c1bd3b22f796f |  3.4.23 |   20 kB |     false |      false |         6 |         14 |                 14 |        |</span><br><span class="line">| http://192.168.10.100:22379 | b112a60ec305e42a |  3.4.23 |   20 kB |     false |      false |         6 |         14 |                 14 |        |</span><br><span class="line">|   http://192.168.10.11:2379 | bc34c6bd673bdf9f |  3.4.23 |   20 kB |     false |      false |         6 |         14 |                 14 |        |</span><br><span class="line">+-----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br></pre></td></tr></table></figure>

<h3 id="93020cb7"><font style="background-color:rgba(255, 255, 255, 0);">删除成员</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">主要用法如下所示：</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl member remove &lt;memberID&gt; [flags]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">模拟192.168.10.100:22379节点下线操作</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban etcd]# docker stop etcd4</span><br><span class="line">etcd4</span><br><span class="line">[root@tiaoban etcd]# docker rm etcd4</span><br><span class="line">etcd4</span><br><span class="line">[root@tiaoban etcd]# etcdctl member remove b112a60ec305e42a</span><br><span class="line">Member b112a60ec305e42a removed from cluster cd30cff36981306b</span><br><span class="line">[root@tiaoban etcd]# etcdctl endpoint status --cluster -w table</span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|          ENDPOINT          |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">| http://192.168.10.100:2379 | 2e0eda3ad6bc6e1e |  3.4.23 |   20 kB |      true |      false |         6 |         16 |                 16 |        |</span><br><span class="line">|  http://192.168.10.12:2379 | 5d2c1bd3b22f796f |  3.4.23 |   20 kB |     false |      false |         6 |         16 |                 16 |        |</span><br><span class="line">|  http://192.168.10.11:2379 | bc34c6bd673bdf9f |  3.4.23 |   20 kB |     false |      false |         6 |         16 |                 16 |        |</span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br></pre></td></tr></table></figure>

<h2 id="f4ce7445"><font style="background-color:rgba(255, 255, 255, 0);">数据库操作命令</font></h2>
---

<h3 id="7b67e8eb"><font style="background-color:rgba(255, 255, 255, 0);">增加(put)</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">添加一个键值，基本用法如下所示：</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl put [options] &lt;key&gt; &lt;value&gt; [flags]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">常用参数如下所示：</font></p>
<table>
<thead>
<tr>
<th><strong><font style="background-color:rgba(255, 255, 255, 0);">参数</font></strong></th>
<th><strong><font style="background-color:rgba(255, 255, 255, 0);">功能描述</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">–prev-kv</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">输出修改前的键值</font></td>
</tr>
</tbody></table>
<p><font style="background-color:rgba(255, 255, 255, 0);">注意事项：</font></p>
<ul>
<li><font style="background-color:rgba(255, 255, 255, 0);">其中value接受从stdin的输入内容</font></li>
<li><font style="background-color:rgba(255, 255, 255, 0);">如果value是以横线-开始，将会被视为flag，如果不希望出现这种情况，可以使用两个横线代替–</font></li>
<li><font style="background-color:rgba(255, 255, 255, 0);">若键已经存在，则进行更新并覆盖原有值，若不存在，则进行添加</font></li>
</ul>
<p><font style="background-color:rgba(255, 255, 255, 0);">示例</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban etcd]# etcdctl put name cuiliang</span><br><span class="line">OK</span><br><span class="line">[root@tiaoban etcd]# etcdctl put location -- -beijing</span><br><span class="line">OK</span><br><span class="line">[root@tiaoban etcd]# etcdctl put foo1 bar1</span><br><span class="line">OK</span><br><span class="line">[root@tiaoban etcd]# etcdctl put foo2 bar2</span><br><span class="line">OK</span><br><span class="line">[root@tiaoban etcd]# etcdctl put foo3 bar3</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<h3 id="b9026f46"><font style="background-color:rgba(255, 255, 255, 0);">查询(get)</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">查询键值，基本用法如下所示：</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl get [options] &lt;key&gt; [range_end] [flags]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">常用参数如下所示：</font></p>
<table>
<thead>
<tr>
<th><strong><font style="background-color:rgba(255, 255, 255, 0);">参数</font></strong></th>
<th><strong><font style="background-color:rgba(255, 255, 255, 0);">功能描述</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">–hex</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">以十六进制形式输出</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">–limit number</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">设置输出结果的最大值</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">–prefix</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">根据prefix进行匹配key</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">–order</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">对输出结果进行排序，ASCEND 或 DESCEND</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">–sort-by</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">按给定字段排序，CREATE, KEY, MODIFY, VALUE, VERSION</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">–print-value-only</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">仅输出value值</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">–from-key</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">按byte进行比较，获取大于等于指定key的结果</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">–keys-only</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">仅获取keys</font></td>
</tr>
</tbody></table>
<p><font style="background-color:rgba(255, 255, 255, 0);">示例</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 获取键值</span><br><span class="line">[root@tiaoban etcd]# etcdctl get name</span><br><span class="line">name</span><br><span class="line">cuiliang</span><br><span class="line"># 只获取值</span><br><span class="line">[root@tiaoban etcd]# etcdctl get location --print-value-only</span><br><span class="line">-beijing</span><br><span class="line"># 批量取从foo1到foo3的值，不包括foo3</span><br><span class="line">[root@tiaoban etcd]# etcdctl get foo foo3 --print-value-only</span><br><span class="line">bar1</span><br><span class="line">bar2</span><br><span class="line"># 批量获取前缀为foo的值</span><br><span class="line">[root@tiaoban etcd]# etcdctl get --prefix foo --print-value-only</span><br><span class="line">bar1</span><br><span class="line">bar2</span><br><span class="line">bar3</span><br><span class="line"># 批量获取符合前缀的前两个值</span><br><span class="line">[root@tiaoban etcd]# etcdctl get --prefix --limit=2 foo --print-value-only</span><br><span class="line">bar1</span><br><span class="line">bar2</span><br><span class="line"># 批量获取前缀为foo的值，并排序</span><br><span class="line">[root@tiaoban etcd]# etcdctl get --prefix foo --print-value-only --order DESCEND</span><br><span class="line">bar3</span><br><span class="line">bar2</span><br><span class="line">bar1</span><br></pre></td></tr></table></figure>

<h3 id="800a3375"><font style="background-color:rgba(255, 255, 255, 0);">删除(del)</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">删除键值，基本用法如下所示：</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl del [options] &lt;key&gt; [range_end] [flags]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">常用参数如下所示：</font></p>
<table>
<thead>
<tr>
<th><strong><font style="background-color:rgba(255, 255, 255, 0);">参数</font></strong></th>
<th><strong><font style="background-color:rgba(255, 255, 255, 0);">功能描述</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">–prefix</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">根据prefix进行匹配删除</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">–prev-kv</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">输出删除的键值</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">–from-key</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">按byte进行比较，删除大于等于指定key的结果</font></td>
</tr>
</tbody></table>
<p><font style="background-color:rgba(255, 255, 255, 0);">示例</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 删除name的键值</span><br><span class="line">[root@tiaoban etcd]# etcdctl del name</span><br><span class="line">1</span><br><span class="line"># 删除从foo1到foo3且不包含foo3的键值</span><br><span class="line">[root@tiaoban etcd]# etcdctl del foo1 foo3</span><br><span class="line">2</span><br><span class="line"># 删除前缀为foo的所有键值</span><br><span class="line">[root@tiaoban etcd]# etcdctl del --prefix foo</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<h3 id="1e15cca4"><font style="background-color:rgba(255, 255, 255, 0);">更新(put覆盖)</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">若键已经存在，则进行更新并覆盖原有值，若不存在，则进行添加。</font>

<h3 id="9634c1ef"><font style="background-color:rgba(255, 255, 255, 0);">查询键历史记录查询</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">etcd在每次键值变更时，都会记录变更信息，便于我们查看键变更记录</font>

<h2 id="2c1031f0"><font style="background-color:rgba(255, 255, 255, 0);">监听命令</font></h2>
---

<p><font style="background-color:rgba(255, 255, 255, 0);">watch是监听键或前缀发生改变的事件流， 主要用法如下所示：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl watch [options] [key or prefix] [range_end] [--] [exec-command arg1 arg2 ...] [flags]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">示例如下所示：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 对某个key监听操作，当key1发生改变时，会返回最新值</span><br><span class="line">etcdctl watch name</span><br><span class="line"># 监听key前缀</span><br><span class="line">etcdctl watch name --prefix</span><br><span class="line"># 监听到改变后执行相关操作</span><br><span class="line">etcdctl watch name --  etcdctl get age</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">etcdctl watch name – etcdctl put name Kevin，如果写成，会不会变成死循环，导致无限监视，尽量避免。<br></font><font style="background-color:rgba(255, 255, 255, 0);">示例</font></p>
<h3 id="beae6e09"><font style="background-color:rgba(255, 255, 255, 0);">监听单个键</font></h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># 启动监听命令</span><br><span class="line">[root@tiaoban etcd]# etcdctl watch foo</span><br><span class="line"></span><br><span class="line">#另一个控制台执行新增命令</span><br><span class="line">[root@tiaoban ~]# etcdctl put foo bar</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"># 观察控制台监听输出</span><br><span class="line">[root@tiaoban etcd]# etcdctl watch foo</span><br><span class="line">PUT</span><br><span class="line">foo</span><br><span class="line">bar</span><br><span class="line"></span><br><span class="line">#另一个控制台执行更新命令</span><br><span class="line">[root@tiaoban ~]# etcdctl put foo bar123</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"># 观察控制台监听输出</span><br><span class="line">[root@tiaoban etcd]# etcdctl watch foo</span><br><span class="line">PUT</span><br><span class="line">foo</span><br><span class="line">bar</span><br><span class="line">PUT</span><br><span class="line">foo</span><br><span class="line">bar123</span><br><span class="line"></span><br><span class="line">#另一个控制台执行删除命令</span><br><span class="line">[root@tiaoban ~]# etcdctl del foo</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line"># 观察控制台监听输出</span><br><span class="line">[root@tiaoban etcd]# etcdctl watch foo</span><br><span class="line">PUT</span><br><span class="line">foo</span><br><span class="line">bar</span><br><span class="line">PUT</span><br><span class="line">foo</span><br><span class="line">bar123</span><br><span class="line">DELETE</span><br><span class="line">foo</span><br></pre></td></tr></table></figure>

<h3 id="8545b8fc"><font style="background-color:rgba(255, 255, 255, 0);">同时监听多个键</font></h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># 监听前缀为foo的键</span><br><span class="line">[root@tiaoban etcd]# etcdctl watch --prefix foo</span><br><span class="line"># 另一个控制台执行操作</span><br><span class="line">[root@tiaoban ~]# etcdctl put foo1 bar1</span><br><span class="line">OK</span><br><span class="line">[root@tiaoban ~]# etcdctl put foo2 bar2</span><br><span class="line">OK</span><br><span class="line">[root@tiaoban ~]# etcdctl del foo1</span><br><span class="line">1</span><br><span class="line"># 观察控制台输出</span><br><span class="line">[root@tiaoban etcd]# etcdctl watch --prefix foo</span><br><span class="line">PUT</span><br><span class="line">foo1</span><br><span class="line">bar1</span><br><span class="line">PUT</span><br><span class="line">foo2</span><br><span class="line">bar2</span><br><span class="line">DELETE</span><br><span class="line">foo1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 监听指定的多个键</span><br><span class="line">[root@tiaoban etcd]# etcdctl watch -i</span><br><span class="line">watch name</span><br><span class="line">watch location</span><br><span class="line"></span><br><span class="line"># 另一个控制台执行操作</span><br><span class="line">[root@tiaoban ~]# etcdctl put name cuiliang</span><br><span class="line">OK</span><br><span class="line">[root@tiaoban ~]# etcdctl del name</span><br><span class="line">1</span><br><span class="line">[root@tiaoban ~]# etcdctl put location beijing</span><br><span class="line">OK</span><br><span class="line"># 观察控制台输出</span><br><span class="line">[root@tiaoban etcd]# etcdctl watch -i</span><br><span class="line">watch name</span><br><span class="line">watch location</span><br><span class="line">PUT</span><br><span class="line">name</span><br><span class="line">cuiliang</span><br><span class="line">DELETE</span><br><span class="line">name</span><br><span class="line"></span><br><span class="line">PUT</span><br><span class="line">location</span><br><span class="line">beijing</span><br></pre></td></tr></table></figure>

<h2 id="dc4e3ec3"><font style="background-color:rgba(255, 255, 255, 0);">租约命令</font></h2>
---

<p><font style="background-color:rgba(255, 255, 255, 0);">租约具有生命周期，需要为租约授予一个TTL(time to live)，将租约绑定到一个key上，则key的生命周期与租约一致，可续租，可撤销租约，类似于redis为键设置过期时间。其主要用法如下所示：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl lease &lt;subcommand&gt; [flags]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<h3 id="70ab4a10"><font style="background-color:rgba(255, 255, 255, 0);">添加租约</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">主要用法如下所示：</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl lease grant &lt;ttl&gt; [flags]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">示例：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 设置60秒后过期时间</span><br><span class="line">[root@tiaoban etcd]# etcdctl lease grant 60</span><br><span class="line">lease 6e1e86f4c6512a2b granted with TTL(60s)</span><br><span class="line"># 把foo和租约绑定，设置成60秒后过期</span><br><span class="line">[root@tiaoban etcd]# etcdctl put --lease=6e1e86f4c6512a29 foo bar</span><br><span class="line">OK</span><br><span class="line"># 租约期内查询键值</span><br><span class="line">[root@tiaoban etcd]# etcdctl get foo</span><br><span class="line">foo</span><br><span class="line">bar</span><br><span class="line"># 租约期外查询键值</span><br><span class="line">[root@tiaoban etcd]# etcdctl get foo</span><br><span class="line">返回为空</span><br></pre></td></tr></table></figure>

<h3 id="84e9d55c"><font style="background-color:rgba(255, 255, 255, 0);">查看租约</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">查看租约信息，以便续租或查看租约是否仍然存在或已过期。  
</font><font style="background-color:rgba(255, 255, 255, 0);">查看租约详情主要用法如下所示：</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl lease timetolive &lt;leaseID&gt; [options] [flags]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">示例：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 添加一个50秒的租约</span><br><span class="line">[root@tiaoban etcd]# etcdctl lease grant 50</span><br><span class="line">lease 6e1e86f4c6512a32 granted with TTL(50s)</span><br><span class="line"># 将name键绑定到6e1e86f4c6512a32租约上</span><br><span class="line">[root@tiaoban etcd]# etcdctl put --lease=6e1e86f4c6512a32 name cuiliang</span><br><span class="line">OK</span><br><span class="line"># 查看所有租约列表</span><br><span class="line">[root@tiaoban etcd]# etcdctl lease list</span><br><span class="line">found 1 leases</span><br><span class="line">6e1e86f4c6512a32</span><br><span class="line"># 查看租约详情，remaining(6s) 剩余有效时间6秒；--keys 获取租约绑定的 key</span><br><span class="line">[root@tiaoban etcd]# etcdctl lease timetolive --keys 6e1e86f4c6512a32</span><br><span class="line">lease 6e1e86f4c6512a32 granted with TTL(50s), remaining(6s), attached keys([name])</span><br></pre></td></tr></table></figure>

<h3 id="536b7b10"><font style="background-color:rgba(255, 255, 255, 0);">租约续约</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">通过刷新 TTL 值来保持租约的有效，使其不会过期。  
</font><font style="background-color:rgba(255, 255, 255, 0);">主要用法如下所示：</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl lease keep-alive [options] &lt;leaseID&gt; [flags]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">示例如下所示：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 设置60秒后过期租约</span><br><span class="line">[root@tiaoban etcd]# etcdctl lease grant 60</span><br><span class="line">lease 6e1e86f4c6512a36 granted with TTL(60s)</span><br><span class="line"># 把name和租约绑定，设置成 60 秒后过期</span><br><span class="line">[root@tiaoban etcd]# etcdctl put --lease=6e1e86f4c6512a36 name cuiliang</span><br><span class="line">OK</span><br><span class="line"># 自动定时执行续约，续约成功后每次租约为60秒</span><br><span class="line">[root@tiaoban etcd]# etcdctl lease keep-alive 6e1e86f4c6512a36</span><br><span class="line">lease 6e1e86f4c6512a36 keepalived with TTL(60)</span><br><span class="line">lease 6e1e86f4c6512a36 keepalived with TTL(60)</span><br><span class="line">lease 6e1e86f4c6512a36 keepalived with TTL(60)</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<h3 id="92a5dd2d"><font style="background-color:rgba(255, 255, 255, 0);">删除租约</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">通过租约 ID 撤销租约，撤销租约将删除其所有绑定的 key。  
</font><font style="background-color:rgba(255, 255, 255, 0);">主要用法如下所示：</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl lease revoke &lt;leaseID&gt; [flags]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">示例如下所示：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 设置600秒后过期租约</span><br><span class="line">[root@tiaoban etcd]# etcdctl lease grant 600</span><br><span class="line">lease 6e1e86f4c6512a39 granted with TTL(600s)</span><br><span class="line"># 把foo和租约绑定，600秒后过期</span><br><span class="line">[root@tiaoban etcd]# etcdctl put --lease=6e1e86f4c6512a39 foo bar</span><br><span class="line">OK</span><br><span class="line"># 查看租约详情</span><br><span class="line">[root@tiaoban etcd]# etcdctl lease timetolive --keys 6e1e86f4c6512a39</span><br><span class="line">lease 6e1e86f4c6512a39 granted with TTL(600s), remaining(556s), attached keys([foo])</span><br><span class="line"># 删除租约</span><br><span class="line">[root@tiaoban etcd]# etcdctl lease revoke 6e1e86f4c6512a39</span><br><span class="line">lease 6e1e86f4c6512a39 revoked</span><br><span class="line"># 查看租约详情</span><br><span class="line">[root@tiaoban etcd]# etcdctl lease timetolive --keys 6e1e86f4c6512a39</span><br><span class="line">lease 6e1e86f4c6512a39 already expired</span><br><span class="line"># 获取键值</span><br><span class="line">[root@tiaoban etcd]# etcdctl get foo</span><br><span class="line">返回为空</span><br></pre></td></tr></table></figure>

<h3 id="1f35a899"><font style="background-color:rgba(255, 255, 255, 0);">多key同一租约</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">一个租约支持绑定多个 key</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 设置60秒后过期的租约</span><br><span class="line">[root@tiaoban etcd]# etcdctl lease grant 60</span><br><span class="line">lease 6e1e86f4c6512a3e granted with TTL(60s)</span><br><span class="line"># foo1与租约绑定</span><br><span class="line">[root@tiaoban etcd]# etcdctl put --lease=6e1e86f4c6512a3e foo1 bar1</span><br><span class="line">OK</span><br><span class="line"># foo2与租约绑定</span><br><span class="line">[root@tiaoban etcd]# etcdctl put --lease=6e1e86f4c6512a3e foo2 bar2</span><br><span class="line">OK</span><br><span class="line"># 查看租约详情</span><br><span class="line">[root@tiaoban etcd]# etcdctl lease timetolive --keys 6e1e86f4c6512a3e</span><br><span class="line">lease 6e1e86f4c6512a3e granted with TTL(60s), remaining(14s), attached keys([foo1 foo2])</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">租约过期后，所有 key 值都会被删除，因此：</font></p>
<ul>
<li><font style="background-color:rgba(255, 255, 255, 0);">当租约只绑定了一个 key 时，想删除这个 key，最好的办法是撤销它的租约，而不是直接删除这个 key。</font></li>
<li><font style="background-color:rgba(255, 255, 255, 0);">当租约没有绑定key时，应主动把它撤销掉，单纯删除 key 后，续约操作持续进行，会造成内存泄露。</font></li>
</ul>
<p><font style="background-color:rgba(255, 255, 255, 0);">直接删除key演示：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 设置租约并绑定 zoo1</span><br><span class="line">[root@tiaoban etcd]# etcdctl lease grant 60</span><br><span class="line">lease 6e1e86f4c6512a43 granted with TTL(60s)</span><br><span class="line">[root@tiaoban etcd]# etcdctl --lease=6e1e86f4c6512a43 put zoo1 val1</span><br><span class="line">OK</span><br><span class="line"># 续约</span><br><span class="line">[root@tiaoban etcd]# etcdctl lease keep-alive 6e1e86f4c6512a43</span><br><span class="line">lease 6e1e86f4c6512a43 keepalived with TTL(60)</span><br><span class="line"></span><br><span class="line"># 此时在另一个控制台执行删除key操作：</span><br><span class="line">[root@tiaoban ~]# etcdctl del zoo1</span><br><span class="line">1</span><br><span class="line"># 单纯删除 key 后，续约操作持续进行，会造成内存泄露</span><br><span class="line">[root@tiaoban etcd]# etcdctl lease keep-alive 6e1e86f4c6512a43</span><br><span class="line">lease 6e1e86f4c6512a43 keepalived with TTL(60)</span><br><span class="line">lease 6e1e86f4c6512a43 keepalived with TTL(60)</span><br><span class="line">lease 6e1e86f4c6512a43 keepalived with TTL(60)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">撤销key的租约演示：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 设置租约并绑定 zoo1</span><br><span class="line">[root@tiaoban etcd]# etcdctl lease grant 50</span><br><span class="line">lease 32698142c52a1717 granted with TTL(50s)</span><br><span class="line">[root@tiaoban etcd]# etcdctl --lease=32698142c52a1717 put zoo1 val1</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"># 续约</span><br><span class="line">[root@tiaoban etcd]# etcdctl lease keep-alive 32698142c52a1717</span><br><span class="line">lease 32698142c52a1717 keepalived with TTL(50)</span><br><span class="line">lease 32698142c52a1717 keepalived with TTL(50)</span><br><span class="line"></span><br><span class="line"># 另一个控制台执行：etcdctl lease revoke 32698142c52a1717</span><br><span class="line"></span><br><span class="line"># 续约撤销并退出</span><br><span class="line">lease 32698142c52a1717 expired or revoked.</span><br><span class="line">[root@tiaoban etcd]# etcdctl get zoo1</span><br><span class="line"># 返回空</span><br></pre></td></tr></table></figure>

<h2 id="17c28d47"><font style="background-color:rgba(255, 255, 255, 0);">备份恢复命令</font></h2>
---

<p><font style="background-color:rgba(255, 255, 255, 0);">主要用于管理节点的快照，其主要用法如下所示：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl snapshot &lt;subcommand&gt; [flags]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<h3 id="f1184f61"><font style="background-color:rgba(255, 255, 255, 0);">生成快照</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">其主要用法如下所示：</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl snapshot save &lt;filename&gt; [flags]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">示例如下所示：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl snapshot save etcd-snapshot.db</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<h3 id="077a284f"><font style="background-color:rgba(255, 255, 255, 0);">查看快照</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">其主要用法如下所示：</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl snapshot status &lt;filename&gt; [flags]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">示例如下所示：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl snapshot status etcd-snapshot.db -w table</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<h3 id="af357963"><font style="background-color:rgba(255, 255, 255, 0);">恢复快照</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">其主要用法如下所示：</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl snapshot restore &lt;filename&gt; [options] [flags]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<h3 id="0255a4be"><font style="background-color:rgba(255, 255, 255, 0);">备份恢复演示</font></h3>
+ <font style="background-color:rgba(255, 255, 255, 0);">新建一个名为name的key</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban ~]# etcdctl put name cuiliang</span><br><span class="line">OK</span><br><span class="line">[root@tiaoban ~]# etcdctl get name</span><br><span class="line">name</span><br><span class="line">cuiliang</span><br><span class="line">[root@tiaoban ~]# etcdctl endpoint status -w table</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|      ENDPOINT       |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">| 192.168.10.100:2379 | 2e0eda3ad6bc6e1e |  3.4.23 |   20 kB |      true |      false |         4 |         10 |                 10 |        |</span><br><span class="line">|  192.168.10.11:2379 | bc34c6bd673bdf9f |  3.4.23 |   20 kB |     false |      false |         4 |         10 |                 10 |        |</span><br><span class="line">|  192.168.10.12:2379 | 5d2c1bd3b22f796f |  3.4.23 |   20 kB |     false |      false |         4 |         10 |                 10 |        |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br></pre></td></tr></table></figure>

<ul>
<li><font style="background-color:rgba(255, 255, 255, 0);">生成快照，创建名为snap.db的备份文件</font></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-work1 ~]# etcdctl snapshot save snap.db</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1679220752.5883558,&quot;caller&quot;:&quot;snapshot/v3_snapshot.go:119&quot;,&quot;msg&quot;:&quot;created temporary db file&quot;,&quot;path&quot;:&quot;snap.db.part&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:&quot;2023-03-19T18:12:32.592+0800&quot;,&quot;caller&quot;:&quot;clientv3/maintenance.go:200&quot;,&quot;msg&quot;:&quot;opened snapshot stream; downloading&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1679220752.5924425,&quot;caller&quot;:&quot;snapshot/v3_snapshot.go:127&quot;,&quot;msg&quot;:&quot;fetching snapshot&quot;,&quot;endpoint&quot;:&quot;127.0.0.1:2379&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:&quot;2023-03-19T18:12:32.595+0800&quot;,&quot;caller&quot;:&quot;clientv3/maintenance.go:208&quot;,&quot;msg&quot;:&quot;completed snapshot read; closing&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1679220752.597161,&quot;caller&quot;:&quot;snapshot/v3_snapshot.go:142&quot;,&quot;msg&quot;:&quot;fetched snapshot&quot;,&quot;endpoint&quot;:&quot;127.0.0.1:2379&quot;,&quot;size&quot;:&quot;25 kB&quot;,&quot;took&quot;:0.008507131&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1679220752.5973082,&quot;caller&quot;:&quot;snapshot/v3_snapshot.go:152&quot;,&quot;msg&quot;:&quot;saved&quot;,&quot;path&quot;:&quot;snap.db&quot;&#125;</span><br><span class="line">Snapshot saved at snap.db</span><br></pre></td></tr></table></figure>

<ul>
<li><font style="background-color:rgba(255, 255, 255, 0);">查看备份文件详情</font></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-work1 ~]# ls -lh snap.db </span><br><span class="line">-rw------- 1 root root 25K 3月  19 18:12 snap.db</span><br><span class="line">[root@k8s-work1 ~]# etcdctl snapshot status snap.db -w table</span><br><span class="line">+----------+----------+------------+------------+</span><br><span class="line">|   HASH   | REVISION | TOTAL KEYS | TOTAL SIZE |</span><br><span class="line">+----------+----------+------------+------------+</span><br><span class="line">| 8f097221 |       39 |         47 |      25 kB |</span><br><span class="line">+----------+----------+------------+------------+</span><br></pre></td></tr></table></figure>

<ul>
<li><font style="background-color:rgba(255, 255, 255, 0);">把快照文件传到其他节点</font></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-work1 ~]# scp snap.db 192.168.10.100:/root                                                                                                                      100%   24KB   6.9MB/s   00:00    </span><br><span class="line">[root@k8s-work1 ~]# scp snap.db 192.168.10.12:/root</span><br></pre></td></tr></table></figure>

<ul>
<li><font style="background-color:rgba(255, 255, 255, 0);">停止所有节点的etcd服务，并删除数据目录</font></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-work1 ~]# systemctl stop etcd</span><br><span class="line">[root@k8s-work1 ~]# rm -rf /data/etcd</span><br><span class="line"># 其余两个节点相同操作</span><br></pre></td></tr></table></figure>

<ul>
<li><font style="background-color:rgba(255, 255, 255, 0);">在所有节点上开始恢复数据</font></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-work1 ~]# etcdctl snapshot restore snap.db --name=etcd2 --data-dir=/data/etcd/cluster.etcd --initial-cluster=etcd1=http://192.168.10.100:2380,etcd2=http://192.168.10.11:2380,etcd3=http://192.168.10.12:2380 --initial-advertise-peer-urls=http://192.168.10.11:2380</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1679221421.2932272,&quot;caller&quot;:&quot;snapshot/v3_snapshot.go:296&quot;,&quot;msg&quot;:&quot;restoring snapshot&quot;,&quot;path&quot;:&quot;snap.db&quot;,&quot;wal-dir&quot;:&quot;/data/etcd/cluster.etcd/member/wal&quot;,&quot;data-dir&quot;:&quot;/data/etcd/cluster.etcd&quot;,&quot;snap-dir&quot;:&quot;/data/etcd/cluster.etcd/member/snap&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1679221421.3019996,&quot;caller&quot;:&quot;membership/cluster.go:392&quot;,&quot;msg&quot;:&quot;added member&quot;,&quot;cluster-id&quot;:&quot;cd30cff36981306b&quot;,&quot;local-member-id&quot;:&quot;0&quot;,&quot;added-peer-id&quot;:&quot;2e0eda3ad6bc6e1e&quot;,&quot;added-peer-peer-urls&quot;:[&quot;http://192.168.10.100:2380&quot;]&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1679221421.30208,&quot;caller&quot;:&quot;membership/cluster.go:392&quot;,&quot;msg&quot;:&quot;added member&quot;,&quot;cluster-id&quot;:&quot;cd30cff36981306b&quot;,&quot;local-member-id&quot;:&quot;0&quot;,&quot;added-peer-id&quot;:&quot;5d2c1bd3b22f796f&quot;,&quot;added-peer-peer-urls&quot;:[&quot;http://192.168.10.12:2380&quot;]&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1679221421.3021913,&quot;caller&quot;:&quot;membership/cluster.go:392&quot;,&quot;msg&quot;:&quot;added member&quot;,&quot;cluster-id&quot;:&quot;cd30cff36981306b&quot;,&quot;local-member-id&quot;:&quot;0&quot;,&quot;added-peer-id&quot;:&quot;bc34c6bd673bdf9f&quot;,&quot;added-peer-peer-urls&quot;:[&quot;http://192.168.10.11:2380&quot;]&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1679221421.3094716,&quot;caller&quot;:&quot;snapshot/v3_snapshot.go:309&quot;,&quot;msg&quot;:&quot;restored snapshot&quot;,&quot;path&quot;:&quot;snap.db&quot;,&quot;wal-dir&quot;:&quot;/data/etcd/cluster.etcd/member/wal&quot;,&quot;data-dir&quot;:&quot;/data/etcd/cluster.etcd&quot;,&quot;snap-dir&quot;:&quot;/data/etcd/cluster.etcd/member/snap&quot;&#125;</span><br><span class="line">[root@tiaoban ~]# etcdctl snapshot restore snap.db --name=etcd1 --data-dir=/data/etcd/cluster.etcd --initial-cluster=etcd1=http://192.168.10.100:2380,etcd2=http://192.168.10.11:2380,etcd3=http://192.168.10.12:2380 --initial-advertise-peer-urls=http://192.168.10.100:2380</span><br><span class="line">[root@k8s-work2 ~]# etcdctl snapshot restore snap.db --name=etcd3 --data-dir=/data/etcd/cluster.etcd --initial-cluster=etcd1=http://192.168.10.100:2380,etcd2=http://192.168.10.11:2380,etcd3=http://192.168.10.12:2380 --initial-advertise-peer-urls=http://192.168.10.12:2380</span><br></pre></td></tr></table></figure>

<ul>
<li><font style="background-color:rgba(255, 255, 255, 0);">所有节点重启etcd服务</font></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban ~]# systemctl restart etcd</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<ul>
<li><font style="background-color:rgba(255, 255, 255, 0);">查看验证</font></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban ~]# etcdctl get name</span><br><span class="line">name</span><br><span class="line">cuiliang</span><br><span class="line">[root@tiaoban ~]# etcdctl endpoint status -w table</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|      ENDPOINT       |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">| 192.168.10.100:2379 | 2e0eda3ad6bc6e1e |  3.4.23 |   20 kB |      true |      false |         4 |         10 |                 10 |        |</span><br><span class="line">|  192.168.10.11:2379 | bc34c6bd673bdf9f |  3.4.23 |   20 kB |     false |      false |         4 |         10 |                 10 |        |</span><br><span class="line">|  192.168.10.12:2379 | 5d2c1bd3b22f796f |  3.4.23 |   20 kB |     false |      false |         4 |         10 |                 10 |        |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">重启etcd后，仍能正常获取name的值，并且节点ID未发生改变。</font></p>
<h2 id="7c91fffc"><font style="background-color:rgba(255, 255, 255, 0);">用户管理命令</font></h2>
---

<p><font style="background-color:rgba(255, 255, 255, 0);">etcd默认是没有开启访问控制的，如果开启外网访问etcd的话就需要考虑访问控制的问题，etcd提供了两种访问控制的方式：</font></p>
<ul>
<li><font style="background-color:rgba(255, 255, 255, 0);">基于身份验证的访问控制</font></li>
<li><font style="background-color:rgba(255, 255, 255, 0);">基于证书的访问控制</font></li>
</ul>
<p><font style="background-color:rgba(255, 255, 255, 0);">从v3.2版本开始，如果使用参数 –client-cert-auth&#x3D;true 启动etcd服务器，则客户端的TLS证书中的 “通用名称（CN）” 字段将用作 etcd 用户。在这种情况下，公用名将对用户进行身份验证，并且客户端不需要密码。如果同时传递了 –client-cert-auth&#x3D;true 且客户端提供了 CN，并且客户端提供了用户名和密码，则将优先考虑基于用户名和密码的身份验证。<br></font><font style="background-color:rgba(255, 255, 255, 0);">etcd有一个特殊用户root和一个特殊角色root：</font></p>
<ul>
<li><strong><font style="background-color:rgba(255, 255, 255, 0);">root用户</font></strong><font style="background-color:rgba(255, 255, 255, 0);">：root用户是etcd的超级管理员，拥有etcd的所有权限，在开启角色认证之前为们必须要先建立好root用户</font></li>
<li><strong><font style="background-color:rgba(255, 255, 255, 0);">root角色</font></strong><font style="background-color:rgba(255, 255, 255, 0);">：具有该root角色的用户既具有全局读写访问权限，具有更新集群的身份验证配置的权限。此外，该root角色还授予常规集群维护的特权，包括修改集群成员资格，对存储进行碎片整理以及拍摄快照。</font></li>
</ul>
<p><font style="background-color:rgba(255, 255, 255, 0);">etcd的权限资源：</font></p>
<ul>
<li><strong><font style="background-color:rgba(255, 255, 255, 0);">Users</font></strong><font style="background-color:rgba(255, 255, 255, 0);">: user用来设置身份认证(user:passwd)，一个用户可以拥有多个角色，每个角色被分配一定的权限(只读、只写、可读写)，用户分为root用户和非root用户。</font></li>
<li><strong><font style="background-color:rgba(255, 255, 255, 0);">Roles</font></strong><font style="background-color:rgba(255, 255, 255, 0);">: 角色用来关联权限，角色主要三类：<br></font><font style="background-color:rgba(255, 255, 255, 0);">root角色:默认创建root用户时即创建了root角色，该角色拥有所有权限；<br></font><font style="background-color:rgba(255, 255, 255, 0);">guest角色:默认自动创建，主要用于非认证使用。普通角色，<br></font><font style="background-color:rgba(255, 255, 255, 0);">由root用户创建角色，并分配指定权限。</font></li>
<li><strong><font style="background-color:rgba(255, 255, 255, 0);">Permissions</font></strong><font style="background-color:rgba(255, 255, 255, 0);">: 权限分为只读、只写、可读写三种权限，权限即对指定目录或key的读写权限。</font></li>
</ul>
<p><font style="background-color:rgba(255, 255, 255, 0);">如果没有指定任何验证方式，即未显示指定以什么用户进行访问，那么默认会设定为 guest 角色。默认情况下 guest 也是具有全局访问权限的</font></p>
<h3 id="7d94de1c"><font style="background-color:rgba(255, 255, 255, 0);">用户管理</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">其主要用法如下所示：</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl user &lt;subcommand&gt; [flags]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">其主要子命令主要如下所示：</font></p>
<table>
<thead>
<tr>
<th><strong><font style="background-color:rgba(255, 255, 255, 0);">子命令</font></strong></th>
<th><strong><font style="background-color:rgba(255, 255, 255, 0);">常用用法</font></strong></th>
<th><strong><font style="background-color:rgba(255, 255, 255, 0);">功能描述</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">add</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">etcdctl user add &lt; user name or user:password &gt; [options] [flags]</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">添加新用户</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">delete</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">etcdctl user delete &lt; user name &gt; [flags]</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">删除用户</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">list</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">etcdctl user list [flags]</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">列出所有用户</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">get</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">etcdctl user get &lt; user name &gt; [options] [flags]</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">获取用户详细信息</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">passwd</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">etcdctl user passwd &lt; user name &gt; [options] [flags]</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">修改密码</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">grant-role</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">etcdctl user grant-role &lt; user name &gt; &lt; role name &gt; [flags]</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">赋予用户角色</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">revoke-role</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">etcdctl user revoke-role &lt; user name &gt; &lt; role name &gt; [flags]</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">删除用户角色</font></td>
</tr>
</tbody></table>
<h3 id="3f856ec2"><font style="background-color:rgba(255, 255, 255, 0);">角色管理</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">其主要用法如下所示：</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl role &lt;subcommand&gt; [flags]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">其主要子命令主要如下所示：</font></p>
<table>
<thead>
<tr>
<th><strong><font style="background-color:rgba(255, 255, 255, 0);">子命令</font></strong></th>
<th><strong><font style="background-color:rgba(255, 255, 255, 0);">常用用法</font></strong></th>
<th><strong><font style="background-color:rgba(255, 255, 255, 0);">功能描述</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">add</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">etcdctl role add &lt; role name &gt; [flags]</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">添加角色</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">delete</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">etcdctl role delete[flags]</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">删除角色</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">list</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">etcdctl role list [flags]</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">列出所有角色</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">get</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">etcdctl role get[flags]</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">获取角色详情</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">grant-permission</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">etcdctl role grant-permission [options] &lt; role name &gt; &lt; permission type &gt; &lt; key &gt; [endkey] [flags]</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">把key操作权限授予给一个角色</font></td>
</tr>
<tr>
<td><font style="background-color:rgba(255, 255, 255, 0);">revoke-permission</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">etcdctl role revoke-permission &lt; role name &gt; &lt; key &gt; [endkey] [flags]</font></td>
<td><font style="background-color:rgba(255, 255, 255, 0);">从角色中撤销key操作权限</font></td>
</tr>
</tbody></table>
<h3 id="2c28d63a"><font style="background-color:rgba(255, 255, 255, 0);">开启root身份验证</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">在开启身份验证后，注意事项如下所示：</font>

<ul>
<li><font style="background-color:rgba(255, 255, 255, 0);">开启身份验证：所有etcdctl命令操作都需要指定用户参数–user，参数值为用户名:密码</font></li>
<li><font style="background-color:rgba(255, 255, 255, 0);">开启证书验证：所有etcdctl命令操作都需要添加证书参数–cacert</font></li>
</ul>
<p><font style="background-color:rgba(255, 255, 255, 0);">开启root身份验证的步骤如下所示：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 添加root 用户，密码为123456</span><br><span class="line">[root@tiaoban ~]# etcdctl user add root:123456</span><br><span class="line">User root created</span><br><span class="line"># 开启身份验证，开启为enable，取消为disable</span><br><span class="line">[root@tiaoban ~]# etcdctl auth enable --user=root:123456</span><br><span class="line">Authentication Enabled</span><br><span class="line"># 在开启身份验证后，直接获取键值报错</span><br><span class="line">[root@tiaoban ~]# etcdctl get name</span><br><span class="line">&#123;&quot;level&quot;:&quot;warn&quot;,&quot;ts&quot;:&quot;2023-03-19T19:00:03.922+0800&quot;,&quot;caller&quot;:&quot;clientv3/retry_interceptor.go:62&quot;,&quot;msg&quot;:&quot;retrying of unary invoker failed&quot;,&quot;target&quot;:&quot;endpoint://client-bdd66650-a0b8-4fb4-ab60-47336cfb7523/192.168.10.100:2379&quot;,&quot;attempt&quot;:0,&quot;error&quot;:&quot;rpc error: code = InvalidArgument desc = etcdserver: user name is empty&quot;&#125;</span><br><span class="line">Error: etcdserver: user name is empty</span><br><span class="line"># 添加用户信息访问</span><br><span class="line">[root@tiaoban ~]# etcdctl get name --user=root:123456</span><br><span class="line">name</span><br><span class="line">cuiliang</span><br></pre></td></tr></table></figure>

<h3 id="debce981"><font style="background-color:rgba(255, 255, 255, 0);">角色授权</font></h3>
<font style="background-color:rgba(255, 255, 255, 0);">在开启了root身份验证后，就可以对普通用户和角色操作了。  
</font>**<font style="background-color:rgba(255, 255, 255, 0);">用户增删改查</font>**

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 增加普通用户</span><br><span class="line">[root@tiaoban ~]# etcdctl user add test:123 --user=root:123456</span><br><span class="line">User test created</span><br><span class="line"># 获取用户信息</span><br><span class="line">[root@tiaoban ~]# etcdctl user get test --user=root:123456</span><br><span class="line">User: test</span><br><span class="line">Roles:</span><br><span class="line"># 查看所有用户</span><br><span class="line">[root@tiaoban ~]# etcdctl user list --user=root:123456</span><br><span class="line">root</span><br><span class="line">test</span><br><span class="line"># 修改用户密码</span><br><span class="line">[root@tiaoban ~]# etcdctl user passwd test --user=root:123456</span><br><span class="line">Password of test: </span><br><span class="line">Type password of test again for confirmation: </span><br><span class="line">Password updated</span><br><span class="line"># 删除用户</span><br><span class="line">[root@tiaoban ~]# etcdctl user delete test --user=root:123456</span><br><span class="line">User test deleted</span><br></pre></td></tr></table></figure>

<p><strong><font style="background-color:rgba(255, 255, 255, 0);">角色增删改查</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 添加角色</span><br><span class="line">[root@tiaoban ~]# etcdctl role add test-role --user=root:123456</span><br><span class="line">Role test-role created</span><br><span class="line"># 获取角色详细信息</span><br><span class="line">[root@tiaoban ~]# etcdctl role get test-role --user=root:123456</span><br><span class="line">Role test-role</span><br><span class="line">KV Read:</span><br><span class="line">KV Write:</span><br><span class="line"># 获取所有角色</span><br><span class="line">[root@tiaoban ~]# etcdctl role list --user=root:123456</span><br><span class="line">root</span><br><span class="line">test-role</span><br><span class="line"># 删除角色</span><br><span class="line">[root@tiaoban ~]# etcdctl role delete test-role --user=root:123456</span><br><span class="line">Role test-role deleted</span><br></pre></td></tr></table></figure>

<p><strong><font style="background-color:rgba(255, 255, 255, 0);">用户角色绑定</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 增加普通用户</span><br><span class="line">[root@tiaoban ~]# etcdctl user add test:123 --user=root:123456</span><br><span class="line">User test created</span><br><span class="line"># 添加角色</span><br><span class="line">[root@tiaoban ~]# etcdctl role add test-role --user=root:123456</span><br><span class="line">Role test-role created</span><br><span class="line"># 将角色绑定给指定用户</span><br><span class="line">[root@tiaoban ~]# etcdctl user grant-role test test-role --user=root:123456</span><br><span class="line">Role test-role is granted to user test</span><br><span class="line"># 查看用户信息</span><br><span class="line">[root@tiaoban ~]# etcdctl user get test --user=root:123456</span><br><span class="line">User: test</span><br><span class="line">Roles: test-role</span><br><span class="line"></span><br><span class="line"># 取消用户与角色绑定</span><br><span class="line">[root@tiaoban ~]# etcdctl user revoke-role test test-role --user=root:123456</span><br><span class="line">Role test-role is revoked from user test</span><br><span class="line"># 查看用户信息</span><br><span class="line">[root@tiaoban ~]# etcdctl user get test --user=root:123456</span><br><span class="line">User: test</span><br><span class="line">Roles:</span><br></pre></td></tr></table></figure>

<p><strong><font style="background-color:rgba(255, 255, 255, 0);">角色授权</font></strong><font style="background-color:rgba(255, 255, 255, 0);"><br></font><font style="background-color:rgba(255, 255, 255, 0);">权限分为：只读（read）、只写(write)和读写(readwrite)权限</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># 使用test用户获取name值会报错，权限拒绝</span><br><span class="line">[root@tiaoban ~]# etcdctl get name --user=test:123</span><br><span class="line">&#123;&quot;level&quot;:&quot;warn&quot;,&quot;ts&quot;:&quot;2023-03-19T19:10:50.515+0800&quot;,&quot;caller&quot;:&quot;clientv3/retry_interceptor.go:62&quot;,&quot;msg&quot;:&quot;retrying of unary invoker failed&quot;,&quot;target&quot;:&quot;endpoint://client-dbe4e470-b1f4-40a1-b48f-71fcab9f32f0/192.168.10.100:2379&quot;,&quot;attempt&quot;:0,&quot;error&quot;:&quot;rpc error: code = PermissionDenied desc = etcdserver: permission denied&quot;&#125;</span><br><span class="line">Error: etcdserver: permission denied</span><br><span class="line"></span><br><span class="line"># 按key进行授权，test-role角色可以读写name</span><br><span class="line">[root@tiaoban ~]# etcdctl role grant-permission test-role readwrite name  --user=root:123456</span><br><span class="line">Role test-role updated</span><br><span class="line"># 查看角色权限详情</span><br><span class="line">[root@tiaoban ~]# etcdctl role get test-role --user=root:123456</span><br><span class="line">Role test-role</span><br><span class="line">KV Read:</span><br><span class="line">        name</span><br><span class="line">KV Write:</span><br><span class="line">        name</span><br><span class="line"></span><br><span class="line"># 也可以按key的prefix进行授权</span><br><span class="line">[root@tiaoban ~]# etcdctl role grant-permission test-role readwrite foo --prefix=true --user=root:123456</span><br><span class="line">Role test-role updated</span><br><span class="line"># 查看角色权限详情</span><br><span class="line">[root@tiaoban ~]# etcdctl role get test-role --user=root:123456</span><br><span class="line">Role test-role</span><br><span class="line">KV Read:</span><br><span class="line">        [foo, fop) (prefix foo)</span><br><span class="line">        name</span><br><span class="line">KV Write:</span><br><span class="line">        [foo, fop) (prefix foo)</span><br><span class="line">        name</span><br><span class="line"></span><br><span class="line"># 撤消角色授权</span><br><span class="line">[root@tiaoban ~]# etcdctl role revoke-permission test-role name --user=root:123456</span><br><span class="line">Permission of key name is revoked from role test-role</span><br><span class="line"># 查看角色权限详情</span><br><span class="line">[root@tiaoban ~]# etcdctl role get test-role --user=root:123456</span><br><span class="line">Role test-role</span><br><span class="line">KV Read:</span><br><span class="line">        [foo, fop) (prefix foo)</span><br><span class="line">KV Write:</span><br><span class="line">        [foo, fop) (prefix foo)</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://www.xiaoxi.ink">小熙</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://www.xiaoxi.ink/2025/03/05/3.ETCD%E2%80%94%E2%80%94%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">https://www.xiaoxi.ink/2025/03/05/3.ETCD%E2%80%94%E2%80%94%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/03/05/2.ETCD%E2%80%94%E2%80%94%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/" title="ETCD--安装部署"><img class="cover" src="/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg" onerror="onerror=null;src='/img/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">ETCD--安装部署</div></div><div class="info-2"><div class="info-item-1">安装部署(单机) ---  如果在测试开发环境，想要测试和使用etcd服务，只需要部署一个单点的 etcd 服务即可。 二进制文件部署 + 下载安装软件  123456789101112131415161718192021222324252627# 下载软件包[root@linux9 ~]# wget https://github.com/etcd-io/etcd/releases/download/v3.4.23/etcd-v3.4.23-linux-amd64.tar.gz[root@linux9 ~]# lsetcd-v3.4.23-linux-amd64.tar.gz# 解压到指定目录[root@linux9 ~]# tar -zxf etcd-v3.4.23-linux-amd64.tar.gz -C /usr/local[root@linux9 ~]# cd /usr/local/etcetc/                      etcd-v3.4.23-linux-amd64/ [root@linux9 ~]# cd...</div></div></div></a><a class="pagination-related" href="/2025/03/05/Istio%20Basic/" title="Istio Basic 部署"><img class="cover" src="/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg" onerror="onerror=null;src='/img/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Istio Basic 部署</div></div><div class="info-2"><div class="info-item-1">Istio 简介 Connect, secure, control, and observe services.  连接、安全加固、控制和观察服务的开放平台。  连接（Connect）：智能控制服务之间的调用流量，能够实现灰度升级、AB 测试和红黑部署等功能； 安全加固（Secure）：自动为服务之间的调用提供认证、授权和加密； 控制（Control）：应用用户定义的 policy，保证资源在消费者中公平分配； 观察（Observe）：查看服务运行期间的各种数据，比如日志、监控和 tracing，了解服务的运行情况。  Service Mesh `Service Mesh`(服务网格)可以简单理解为**"分布式代理"**.   Istio 架构 ![](https://cdn.nlark.com/yuque/0/2025/svg/43141749/1741444377049-daa84c0b-0834-4f07-9510-5202b4a8617a.svg)  Istio 安装部署 使用`istioctl`安装 官方详细中文安装文档:...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/%E5%A4%B4%E5%83%8F.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">小熙</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">34</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/jack-xi-jack"><i class="fab fa-github"></i><span>🛴前往小家...</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/jack-xi-jack" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:1643699428@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="/wechat-qr/" target="_blank" title="微信"><i class="fab fa-weixin" style="color: #07C160;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">小熙的技术博客</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#dd367c2e"><span class="toc-number">1.</span> <span class="toc-text">集群管理命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3867e350"><span class="toc-number">1.1.</span> <span class="toc-text">环境变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c66c9b5d"><span class="toc-number">1.2.</span> <span class="toc-text">查看etcd版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#e65806ec"><span class="toc-number">1.3.</span> <span class="toc-text">查看etcd集群节点信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bcf18e5c"><span class="toc-number">1.4.</span> <span class="toc-text">查看集群健康状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cd2c454b"><span class="toc-number">1.5.</span> <span class="toc-text">查看告警事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c3514e94"><span class="toc-number">1.6.</span> <span class="toc-text">添加成员</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8456c2a4"><span class="toc-number">1.7.</span> <span class="toc-text">更新成员</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#93020cb7"><span class="toc-number">1.8.</span> <span class="toc-text">删除成员</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#f4ce7445"><span class="toc-number">2.</span> <span class="toc-text">数据库操作命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7b67e8eb"><span class="toc-number">2.1.</span> <span class="toc-text">增加(put)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b9026f46"><span class="toc-number">2.2.</span> <span class="toc-text">查询(get)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#800a3375"><span class="toc-number">2.3.</span> <span class="toc-text">删除(del)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1e15cca4"><span class="toc-number">2.4.</span> <span class="toc-text">更新(put覆盖)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9634c1ef"><span class="toc-number">2.5.</span> <span class="toc-text">查询键历史记录查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2c1031f0"><span class="toc-number">3.</span> <span class="toc-text">监听命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#beae6e09"><span class="toc-number">3.1.</span> <span class="toc-text">监听单个键</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8545b8fc"><span class="toc-number">3.2.</span> <span class="toc-text">同时监听多个键</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dc4e3ec3"><span class="toc-number">4.</span> <span class="toc-text">租约命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#70ab4a10"><span class="toc-number">4.1.</span> <span class="toc-text">添加租约</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#84e9d55c"><span class="toc-number">4.2.</span> <span class="toc-text">查看租约</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#536b7b10"><span class="toc-number">4.3.</span> <span class="toc-text">租约续约</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#92a5dd2d"><span class="toc-number">4.4.</span> <span class="toc-text">删除租约</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1f35a899"><span class="toc-number">4.5.</span> <span class="toc-text">多key同一租约</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#17c28d47"><span class="toc-number">5.</span> <span class="toc-text">备份恢复命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#f1184f61"><span class="toc-number">5.1.</span> <span class="toc-text">生成快照</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#077a284f"><span class="toc-number">5.2.</span> <span class="toc-text">查看快照</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#af357963"><span class="toc-number">5.3.</span> <span class="toc-text">恢复快照</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0255a4be"><span class="toc-number">5.4.</span> <span class="toc-text">备份恢复演示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7c91fffc"><span class="toc-number">6.</span> <span class="toc-text">用户管理命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7d94de1c"><span class="toc-number">6.1.</span> <span class="toc-text">用户管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3f856ec2"><span class="toc-number">6.2.</span> <span class="toc-text">角色管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2c28d63a"><span class="toc-number">6.3.</span> <span class="toc-text">开启root身份验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#debce981"><span class="toc-number">6.4.</span> <span class="toc-text">角色授权</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/04/10/%E6%8E%92%E6%9F%A5%20device%20or%20resource%20busy%20%E5%89%AF%E6%9C%AC/" title="排查 device or resource busy"><img src="/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg" onerror="this.onerror=null;this.src='/img/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg'" alt="排查 device or resource busy"/></a><div class="content"><a class="title" href="/2025/04/10/%E6%8E%92%E6%9F%A5%20device%20or%20resource%20busy%20%E5%89%AF%E6%9C%AC/" title="排查 device or resource busy">排查 device or resource busy</a><time datetime="2025-04-10T00:16:06.000Z" title="Created 2025-04-10 08:16:06">2025-04-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/07/%E4%BD%BF%E7%94%A8%20wireshark%20%E5%88%86%E6%9E%90%E6%95%B0%E6%8D%AE%E5%8C%85/" title="使用 wireshark 分析数据包"><img src="/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg" onerror="this.onerror=null;this.src='/img/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg'" alt="使用 wireshark 分析数据包"/></a><div class="content"><a class="title" href="/2025/04/07/%E4%BD%BF%E7%94%A8%20wireshark%20%E5%88%86%E6%9E%90%E6%95%B0%E6%8D%AE%E5%8C%85/" title="使用 wireshark 分析数据包">使用 wireshark 分析数据包</a><time datetime="2025-04-07T08:30:00.000Z" title="Created 2025-04-07 16:30:00">2025-04-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/04/%E4%BD%BF%E7%94%A8%20tcpdump%20%E6%8A%93%E5%8C%85%E4%B8%8E%E5%88%86%E6%9E%90/" title="使用 tcpdump 抓包与分析"><img src="/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg" onerror="this.onerror=null;this.src='/img/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg'" alt="使用 tcpdump 抓包与分析"/></a><div class="content"><a class="title" href="/2025/04/04/%E4%BD%BF%E7%94%A8%20tcpdump%20%E6%8A%93%E5%8C%85%E4%B8%8E%E5%88%86%E6%9E%90/" title="使用 tcpdump 抓包与分析">使用 tcpdump 抓包与分析</a><time datetime="2025-04-04T00:30:00.000Z" title="Created 2025-04-04 08:30:00">2025-04-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/03/%E4%BD%BF%E7%94%A8%20Systemtap%20%E5%AE%9A%E4%BD%8D%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/" title="使用 Systemtap 定位疑难杂症"><img src="/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg" onerror="this.onerror=null;this.src='/img/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg'" alt="使用 Systemtap 定位疑难杂症"/></a><div class="content"><a class="title" href="/2025/04/03/%E4%BD%BF%E7%94%A8%20Systemtap%20%E5%AE%9A%E4%BD%8D%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/" title="使用 Systemtap 定位疑难杂症">使用 Systemtap 定位疑难杂症</a><time datetime="2025-04-03T00:30:00.000Z" title="Created 2025-04-03 08:30:00">2025-04-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/31/%E4%BD%BF%E7%94%A8%20ksniff%20%E8%BF%9C%E7%A8%8B%E6%8A%93%E5%8C%85%20%E5%89%AF%E6%9C%AC/" title="使用 ksniff 远程抓包 副本"><img src="/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg" onerror="this.onerror=null;this.src='/img/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg'" alt="使用 ksniff 远程抓包 副本"/></a><div class="content"><a class="title" href="/2025/03/31/%E4%BD%BF%E7%94%A8%20ksniff%20%E8%BF%9C%E7%A8%8B%E6%8A%93%E5%8C%85%20%E5%89%AF%E6%9C%AC/" title="使用 ksniff 远程抓包 副本">使用 ksniff 远程抓包 副本</a><time datetime="2025-03-31T00:30:00.000Z" title="Created 2025-03-31 08:30:00">2025-03-31</time></div></div></div></div></div></div></main><footer id="footer" style="background: 小屁股.jpg;"><div id="footer-wrap"><div class="copyright">&copy;2025 By 小熙</div><div class="footer_custom_text">I wish you to become your own sun, no need to rely on who's light.<p><a target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://butterfly.js.org/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://www.jsdelivr.com/"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用JsDelivr为静态资源提供CDN加速"></a> &nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="本站采用双线部署，默认线路托管于Vercel"></a>&nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Coding-0cedbe?style=flat&logo=Codio" title="本站采用双线部署，联通线路托管于Coding"></a>&nbsp;<a target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp;<a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async src="https://npm.elemecdn.com/tzy-blog/lib/js/other/sakura.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      const usePjax = true
      true 
        ? (usePjax ? pjax.loadUrl('/404.html') : window.location.href = '/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>