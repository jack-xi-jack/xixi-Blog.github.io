<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>consul 入门服务注册中心 | 欢迎来到小熙的博客</title><meta name="author" content="小熙"><meta name="copyright" content="小熙"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="基础概念 ---  什么是注册中心 随着微服务理论发展的成熟，越来越多互联网公司采用微服务架构来支持业务发展。各个微服务之间都需要通过注册中心来实现自动化的注册和发现。   ![](https:&#x2F;&#x2F;cdn.nlark.com&#x2F;yuque&#x2F;0&#x2F;2025&#x2F;jpeg&#x2F;43141749&#x2F;1738900841329-403a2378-9696-4410-a98b-791e28e3ccf0.jpeg)   注">
<meta property="og:type" content="article">
<meta property="og:title" content="consul 入门服务注册中心">
<meta property="og:url" content="https://www.xiaoxi.ink/2025/03/08/%E5%85%A5%E9%97%A8%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E2%80%94%E2%80%94consul%20%E5%89%AF%E6%9C%AC/index.html">
<meta property="og:site_name" content="欢迎来到小熙的博客">
<meta property="og:description" content="基础概念 ---  什么是注册中心 随着微服务理论发展的成熟，越来越多互联网公司采用微服务架构来支持业务发展。各个微服务之间都需要通过注册中心来实现自动化的注册和发现。   ![](https:&#x2F;&#x2F;cdn.nlark.com&#x2F;yuque&#x2F;0&#x2F;2025&#x2F;jpeg&#x2F;43141749&#x2F;1738900841329-403a2378-9696-4410-a98b-791e28e3ccf0.jpeg)   注">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.xiaoxi.ink/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg">
<meta property="article:published_time" content="2025-03-08T11:08:06.000Z">
<meta property="article:modified_time" content="2025-03-30T13:07:37.647Z">
<meta property="article:author" content="小熙">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.xiaoxi.ink/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "consul 入门服务注册中心",
  "url": "https://www.xiaoxi.ink/2025/03/08/%E5%85%A5%E9%97%A8%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E2%80%94%E2%80%94consul%20%E5%89%AF%E6%9C%AC/",
  "image": "https://www.xiaoxi.ink/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg",
  "datePublished": "2025-03-08T11:08:06.000Z",
  "dateModified": "2025-03-30T13:07:37.647Z",
  "author": [
    {
      "@type": "Person",
      "name": "小熙",
      "url": "https://www.xiaoxi.ink/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://www.xiaoxi.ink/2025/03/08/%E5%85%A5%E9%97%A8%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E2%80%94%E2%80%94consul%20%E5%89%AF%E6%9C%AC/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":150,"languages":{"author":"Author: 小熙","link":"Link: ","source":"Source: 欢迎来到小熙的博客","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'consul 入门服务注册中心',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/xxx.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/background.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/%E5%A4%B4%E5%83%8F.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: 小屁股.jpg;"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">欢迎来到小熙的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">consul 入门服务注册中心</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">consul 入门服务注册中心</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-03-08T11:08:06.000Z" title="Created 2025-03-08 19:08:06">2025-03-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-03-30T13:07:37.647Z" title="Updated 2025-03-30 21:07:37">2025-03-30</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2025-03-30 21:07:37&quot;}" hidden></div><h1 id="8519e085"><font style="background-color:rgba(255, 255, 255, 0);">基础概念</font></h1>
---

<h2 id="5e372583"><font style="background-color:rgba(255, 255, 255, 0);">什么是注册中心</font></h2>
<font style="background-color:rgba(255, 255, 255, 0);">随着微服务理论发展的成熟，越来越多互联网公司采用微服务架构来支持业务发展。各个微服务之间都需要通过注册中心来实现自动化的注册和发现。  
</font>![](https://cdn.nlark.com/yuque/0/2025/jpeg/43141749/1738900841329-403a2378-9696-4410-a98b-791e28e3ccf0.jpeg)<font style="background-color:rgba(255, 255, 255, 0);">  
</font><font style="background-color:rgba(255, 255, 255, 0);">注册中心主要有三种角色：</font>

<ul>
<li><strong><font style="background-color:rgba(255, 255, 255, 0);">服务提供者（RPC Server）</font></strong><font style="background-color:rgba(255, 255, 255, 0);">：在启动时，向 Registry 注册自身服务，并向 Registry 定期发送心跳汇报存活状态。</font></li>
<li><strong><font style="background-color:rgba(255, 255, 255, 0);">服务消费者（RPC Client）</font></strong><font style="background-color:rgba(255, 255, 255, 0);">：在启动时，向 Registry 订阅服务，把 Registry 返回的服务节点列表缓存在本地内存中，并与 RPC Sever 建立连接。</font></li>
<li><strong><font style="background-color:rgba(255, 255, 255, 0);">服务注册中心（Registry）</font></strong><font style="background-color:rgba(255, 255, 255, 0);">：用于保存 RPC Server 的注册信息，当 RPC Server 节点发生变更时，Registry 会同步变更，RPC Client 感知后会刷新本地 内存中缓存的服务节点列表。</font></li>
</ul>
<p><font style="background-color:rgba(255, 255, 255, 0);">最后，RPC Client 从本地缓存的服务节点列表中，基于负载均衡算法选择一台 RPC Sever 发起调用。<br></font><font style="background-color:rgba(255, 255, 255, 0);">目前常见的注册中心有Consul、ETCD、Zookeeper、Eureka、Nacos等。</font></p>
<h2 id="9cfc6012"><font style="background-color:rgba(255, 255, 255, 0);">什么是Consul</font></h2>
<font style="background-color:rgba(255, 255, 255, 0);">Consul是HashiCorp公司推出的开源工具，Consul由Go语言开发，部署起来非常容易，只需要极少的可执行程序和配置文件，具有绿色、轻量级的特点。Consul是分布式的、高可用的、 可横向扩展的用于实现分布式系统的服务发现与配置。</font>

<h2 id="22750ec8"><font style="background-color:rgba(255, 255, 255, 0);">Consul特点</font></h2>
+ <font style="background-color:rgba(255, 255, 255, 0);">服务发现（Service Discovery）：Consul提供了通过DNS或者HTTP接口的方式来注册服务和发现服务。一些外部的服务通过Consul很容易的找到它所依赖的服务。</font>
+ <font style="background-color:rgba(255, 255, 255, 0);">健康检查（Health Checking）：Consul的Client可以提供任意数量的健康检查，既可以与给定的服务相关联(“webserver是否返回200 OK”)，也可以与本地节点相关联(“内存利用率是否低于90%”)。操作员可以使用这些信息来监视集群的健康状况，服务发现组件可以使用这些信息将流量从不健康的主机路由出去。</font>
+ <font style="background-color:rgba(255, 255, 255, 0);">Key/Value存储：应用程序可以根据自己的需要使用Consul提供的Key/Value存储。 Consul提供了简单易用的HTTP接口，结合其他工具可以实现动态配置、功能标记、领袖选举等等功能。</font>
+ <font style="background-color:rgba(255, 255, 255, 0);">安全服务通信：Consul可以为服务生成和分发TLS证书，以建立相互的TLS连接。意图可用于定义允许哪些服务通信。服务分割可以很容易地进行管理，其目的是可以实时更改的，而不是使用复杂的网络拓扑和静态防火墙规则。</font>
+ <font style="background-color:rgba(255, 255, 255, 0);">多数据中心：Consul支持开箱即用的多数据中心. 这意味着用户不需要担心需要建立额外的抽象层让业务扩展到多个区域。</font>

<h2 id="73539e88"><font style="background-color:rgba(255, 255, 255, 0);">consul组件</font></h2>
+ <font style="background-color:rgba(255, 255, 255, 0);">Agent：是在 Consul 集群的每个成员上长期运行的守护进程，通过命令 consul agent 启动运行。由于所有节点都必须运行一个 Agent，因此 Agent 可以分为 client 或 Server。所有的 Agent 都可以运行DNS或HTTP接口，并负责运行监测和保持服务同步</font>
+ <font style="background-color:rgba(255, 255, 255, 0);">Client：是将所有RPC转发到 Server 的 Agent。Client 是相对无状态的，Client 唯一执行的后台活动是加入 LAN gossip 池。这只有最小的资源开销，且只消耗少量的网络带宽</font>
+ <font style="background-color:rgba(255, 255, 255, 0);">Server：是一个有一组扩展功能的 Agent，这些功能包括参与 Raft 选举、维护集群状态、响应RPC查询、与其他数据中心交互 WAN gossip 和转发查询给 leader 或远程的数据中心</font>
+ <font style="background-color:rgba(255, 255, 255, 0);">Datacenter：是一个私有的、低延迟和高带宽的网络环境。这不包括通过公网的通信，但就目的而言，单个 EC2 中的多个可用区域被视为数据中心的一部分</font>
+ <font style="background-color:rgba(255, 255, 255, 0);">Consensus：一致性。Consul 使用 Consensus 协议（具体由 Raft 算法实现）来提供一致性（由 CAP 定义），表明 leader 选举和事务的顺序达成一致</font>
+ <font style="background-color:rgba(255, 255, 255, 0);">Gossip：Consul 使用 Gossip 协议来管理成员资格并向集群广播消息。Serf 提供了完整的 Gossip 协议，可用于多种目的，而 Consul 建立在 Serf 之上。Gossip 涉及节点到节点的随机通信，主要是通过UDP。Gossip 协议也被称为 Epidemic 协议（流行病协议）</font>
+ <font style="background-color:rgba(255, 255, 255, 0);">LAN Gossip：指包含所有位于同一局域网或数据中心的节点的 LAN gossip 池</font>
+ <font style="background-color:rgba(255, 255, 255, 0);">WAN Gossip：指仅包含 Server 的 WAN gossip 池。这些 Server 主要分布在不同的数据中心，通常通过Internet或者广域网进行通信</font>
+ <font style="background-color:rgba(255, 255, 255, 0);">RPC：远程过程调用。一种 请求/响应 机制，允许 Client 向 Server 发起请求</font>

<h2 id="641185e8"><font style="background-color:rgba(255, 255, 255, 0);">Consul 架构图</font></h2>
![](https://cdn.nlark.com/yuque/0/2025/jpeg/43141749/1738900841304-0599a640-bce7-44a1-8834-3b42cbe90ad9.jpeg)<font style="background-color:rgba(255, 255, 255, 0);">  
</font><font style="background-color:rgba(255, 255, 255, 0);">每个为Consul提供服务的节点都会运行一个Consul Agent进程。运行代理不需要发现其他服务或获取/设置密钥/值数据。Agent负责对节点上的服务以及节点本身进行健康检查。  
</font><font style="background-color:rgba(255, 255, 255, 0);">Consul Agent 分为两种模式， Server 和 Client模式，一般部署模型是 Server + Client的模式（当然也可以纯Server）, Server 具有Client的全部功能， 但是由于Server负责存储数据，并且强一致性模型的缘故， Server数是有限的（3-5个Server节点，Client可以无限扩展的）。  
</font><font style="background-color:rgba(255, 255, 255, 0);">Agent与一个或多个Consul Server对话。Consul Server是</font>**<font style="background-color:rgba(255, 255, 255, 0);">存储</font>**<font style="background-color:rgba(255, 255, 255, 0);">和</font>**<font style="background-color:rgba(255, 255, 255, 0);">复制数据</font>**<font style="background-color:rgba(255, 255, 255, 0);">的地方。Server本身会选出一个Leader。虽然Consul可以用一台Server来运作，但建议使用3到5台，以避免故障情况导致数据丢失。建议每个数据中心采用Consul服务器集群。  
</font><font style="background-color:rgba(255, 255, 255, 0);">Server Agent维护着一个目录（Catalog），这个目录（Catalog）是由Agent提交的信息汇总形成的。目录维护着集群的高层视图，包括哪些服务可用，哪些节点运行这些服务，健康信息等。  
</font><font style="background-color:rgba(255, 255, 255, 0);">需要发现其他服务或节点的基础结构组件可以查询任何Consul Server或任何Consul Agent。Agent将查询自动转发到Server。  
</font><font style="background-color:rgba(255, 255, 255, 0);">Agent会自动将查询转发给Server Agent。 每个数据中心都运行一个Consul Server集群。当有跨数据中心的服务发现或配置请求时，本地Consul Server将请求转发到远程数据中心并返回结果。</font>

<h2 id="236bb442"><font style="background-color:rgba(255, 255, 255, 0);">Consul的使用场景</font></h2>
<font style="background-color:rgba(255, 255, 255, 0);">Consul的应用场景包括服务发现、服务隔离、服务配置：</font>

<ul>
<li><font style="background-color:rgba(255, 255, 255, 0);">服务发现场景中consul作为注册中心，服务地址被注册到consul中以后，可以使用consul提供的dns、http接口查询，consul支持health check。</font></li>
<li><font style="background-color:rgba(255, 255, 255, 0);">服务隔离场景中consul支持以服务为单位设置访问策略，能同时支持经典的平台和新兴的平台，支持tls证书分发，service-to-service加密。</font></li>
<li><font style="background-color:rgba(255, 255, 255, 0);">服务配置场景中consul提供key-value数据存储功能，并且能将变动迅速地通知出去，借助Consul可以实现配置共享，需要读取配置的服务可以从Consul中读取到准确的配置信息。</font></li>
<li><font style="background-color:rgba(255, 255, 255, 0);">Consul可以帮助系统管理者更清晰的了解复杂系统内部的系统架构，运维人员可以将Consul看成一种监控软件，也可以看成一种资产（资源）管理系统。</font></li>
</ul>
<h1 id="039d392c"><font style="background-color:rgba(255, 255, 255, 0);">安装部署</font></h1>
---

<p><font style="background-color:rgba(255, 255, 255, 0);">参考文档：</font><a target="_blank" rel="noopener" href="https://developer.hashicorp.com/consul/downloads?host=www.consul.io"><font style="background-color:rgba(255, 255, 255, 0);">https://developer.hashicorp.com/consul/downloads?host=www.consul.io</font></a></p>
<h2 id="62a5d2da"><font style="background-color:rgba(255, 255, 255, 0);">yum部署</font></h2>
<font style="background-color:rgba(255, 255, 255, 0);">安装软件包</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban ~]# yum install -y yum-utils</span><br><span class="line">[root@tiaoban ~]# yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo</span><br><span class="line">[root@tiaoban ~]# yum -y install consul</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">启动服务</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban ~]# systemctl start consul</span><br><span class="line">[root@tiaoban ~]# systemctl enable consul</span><br></pre></td></tr></table></figure>

<h2 id="4443f491"><font style="background-color:rgba(255, 255, 255, 0);">二进制部署</font></h2>
<font style="background-color:rgba(255, 255, 255, 0);">下载</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban ~]# mkdir consul</span><br><span class="line">[root@tiaoban ~]# cd consul/</span><br><span class="line">[root@tiaoban consul]# wget https://releases.hashicorp.com/consul/1.13.2/consul_1.13.2_linux_amd64.zip</span><br><span class="line">[root@tiaoban consul]# ls</span><br><span class="line">consul_1.13.2_darwin_amd64.zip</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">解压安装</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban consul]# unzip consul_1.13.2_linux_amd64.zip </span><br><span class="line">Archive:  consul_1.13.2_linux_amd64.zip</span><br><span class="line">  inflating: consul                  </span><br><span class="line">[root@tiaoban consul]# ls</span><br><span class="line">consul  consul_1.13.2_linux_amd64.zip</span><br><span class="line">[root@tiaoban consul]# mv consul /usr/local/bin/</span><br><span class="line">[root@tiaoban consul]# consul version</span><br><span class="line">Consul v1.13.2</span><br><span class="line">Revision 0e046bbb</span><br><span class="line">Build Date 2022-09-20T20:30:07Z</span><br><span class="line">Protocol 2 spoken by default, understands 2 to 3 (agent will automatically use protocol &gt;2 when speaking to compatible agents)</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">启动服务测试<br></font><font style="background-color:rgba(255, 255, 255, 0);">使用单节点模式启动测试</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban consul]# consul agent -dev -ui -client 0.0.0.0</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2025/jpeg/43141749/1738900841427-2c5517e2-2c9f-4ae3-9048-de5811f58ea6.jpeg"><font style="background-color:rgba(255, 255, 255, 0);"><br></font><font style="background-color:rgba(255, 255, 255, 0);">添加启动脚本</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban ~]# cat /usr/lib/systemd/system/consul.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=consul</span><br><span class="line">After=network.target</span><br><span class="line">    </span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/consul/start.sh</span><br><span class="line">KillSignal=SIGTERM</span><br><span class="line">    </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@tiaoban ~]# mkdir -p /usr/local/consul/</span><br><span class="line">[root@tiaoban ~]# cat /usr/local/consul/start.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">/usr/local/bin/consul agent -dev -ui -client 0.0.0.0</span><br><span class="line">[root@tiaoban ~]# chmod u+x /usr/local/consul/start.sh</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">启动服务</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban ~]# systemctl daemon-reload </span><br><span class="line">[root@tiaoban ~]# systemctl start consul</span><br><span class="line">[root@tiaoban ~]# systemctl enable consul</span><br></pre></td></tr></table></figure>

<h1 id="b19ba4ef"><font style="background-color:rgba(255, 255, 255, 0);">服务启动</font></h1>
---

<p><font style="background-color:rgba(255, 255, 255, 0);">以下操作以yum方式安装consul配置为例，配置文件路径</font><code>&lt;font style=&quot;background-color:rgba(255, 255, 255, 0);&quot;&gt;/etc/consul.d/consul.hcl&lt;/font&gt;</code></p>
<h2 id="8c7054cf"><font style="background-color:rgba(255, 255, 255, 0);">单节点模式</font></h2>
<font style="background-color:rgba(255, 255, 255, 0);">修改配置文件</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 指明数据中心的名字</span><br><span class="line">datacenter = &quot;my-dc-1&quot;</span><br><span class="line"># 存储状态的数据目录</span><br><span class="line">data_dir = &quot;/opt/consul&quot;</span><br><span class="line"># web ui</span><br><span class="line">ui_config&#123;</span><br><span class="line">  enabled = true</span><br><span class="line">&#125;</span><br><span class="line"># 节点是个Server</span><br><span class="line">server = true</span><br><span class="line"># 绑定的一个地址，用于节点之间通信的地址</span><br><span class="line">bind_addr = &quot;192.168.10.100&quot;</span><br><span class="line"># 期望提供的Server节点数目</span><br><span class="line">bootstrap_expect=1</span><br><span class="line"># Client接口绑定到的地址</span><br><span class="line">client_addr = &quot;0.0.0.0&quot;</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">启动服务，查看集群成员</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban consul.d]# systemctl start consul</span><br><span class="line">[root@tiaoban consul.d]# consul members </span><br><span class="line">Node     Address              Status  Type    Build   Protocol  DC       Partition  Segment</span><br><span class="line">tiaoban  192.168.10.100:8301  alive   server  1.13.2  2         my-dc-1  default    &lt;all&gt;</span><br></pre></td></tr></table></figure>

<h2 id="6955953a"><font style="background-color:rgba(255, 255, 255, 0);">集群模式</font></h2>
<font style="background-color:rgba(255, 255, 255, 0);">主机规划</font>

<table>
<thead>
<tr>
<th><strong>主机名</strong></th>
<th><strong>IP</strong></th>
<th><strong>角色</strong></th>
</tr>
</thead>
<tbody><tr>
<td>k8s-master</td>
<td>192.168.10.10</td>
<td>server</td>
</tr>
<tr>
<td>k8s-work1</td>
<td>192.168.10.11</td>
<td>server</td>
</tr>
<tr>
<td>k8s-work2</td>
<td>192.168.10.12</td>
<td>server</td>
</tr>
<tr>
<td>tiaoban</td>
<td>192.168.10.100</td>
<td>clinet</td>
</tr>
</tbody></table>
<p><font style="background-color:rgba(255, 255, 255, 0);">server端配置</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 指明数据中心的名字</span><br><span class="line">datacenter = &quot;my-dc-1&quot;</span><br><span class="line"># 存储状态的数据目录</span><br><span class="line">data_dir = &quot;/opt/consul&quot;</span><br><span class="line"># web ui</span><br><span class="line">ui_config&#123;</span><br><span class="line">  enabled = true</span><br><span class="line">&#125;</span><br><span class="line"># 节点是个Server</span><br><span class="line">server = true</span><br><span class="line"># 绑定的一个地址，用于节点之间通信的地址。此处以192.168.10.10为例，其他两个更换ip即可。</span><br><span class="line">bind_addr = &quot;192.168.10.10&quot;</span><br><span class="line"># 期望提供的Server节点数目</span><br><span class="line">bootstrap_expect=3</span><br><span class="line"># Client接口绑定到的地址</span><br><span class="line">client_addr = &quot;0.0.0.0&quot;</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">client配置</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 指明数据中心的名字</span><br><span class="line">datacenter = &quot;my-dc-1&quot;</span><br><span class="line"># 存储状态的数据目录</span><br><span class="line">data_dir = &quot;/opt/consul&quot;</span><br><span class="line"># web ui</span><br><span class="line">ui_config&#123;</span><br><span class="line">  enabled = true</span><br><span class="line">&#125;</span><br><span class="line"># 节点是个Server</span><br><span class="line">server = false</span><br><span class="line"># 绑定的一个地址，用于节点之间通信的地址</span><br><span class="line">bind_addr = &quot;192.168.10.100&quot;</span><br><span class="line"># Client接口绑定到的地址</span><br><span class="line">client_addr = &quot;0.0.0.0&quot;</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">启动服务并加入集群</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 所有机器执行</span><br><span class="line">[root@k8s-master consul.d]# systemctl restart consul</span><br><span class="line"># 除了k8s-master以外的其他机器执行</span><br><span class="line">[root@k8s-tiaoban consul.d]# consul join 192.168.10.10</span><br><span class="line">Successfully joined cluster by contacting 1 nodes.</span><br></pre></td></tr></table></figure>

<h1 id="4b194b09"><font style="background-color:rgba(255, 255, 255, 0);">Consul 常用CLI</font></h1>
---

<h2 id="eb75b9f5"><font style="background-color:rgba(255, 255, 255, 0);">查看服务列表</font></h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# consul catalog services</span><br><span class="line">consul</span><br><span class="line">traefik</span><br><span class="line">traefik-tcp</span><br></pre></td></tr></table></figure>

<h2 id="75acbd2e"><font style="background-color:rgba(255, 255, 255, 0);">注销服务</font></h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">consul services deregister -id=:service-id</span><br><span class="line">// :service-id 为用户服务Id</span><br></pre></td></tr></table></figure>

<h2 id="1b4e985d"><font style="background-color:rgba(255, 255, 255, 0);">查看节点成员</font></h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# consul members</span><br><span class="line">Node        Address              Status  Type    Build   Protocol  DC       Partition  Segment</span><br><span class="line">k8s-master  192.168.10.10:8301   alive   server  1.13.3  2         my-dc-1  default    &lt;all&gt;</span><br><span class="line">k8s-work1   192.168.10.11:8301   alive   server  1.13.3  2         my-dc-1  default    &lt;all&gt;</span><br><span class="line">k8s-work2   192.168.10.12:8301   alive   server  1.13.3  2         my-dc-1  default    &lt;all&gt;</span><br><span class="line">tiaoban     192.168.10.100:8301  alive   client  1.13.2  2         my-dc-1  default    &lt;default&gt;</span><br></pre></td></tr></table></figure>

<h2 id="1459fae8"><font style="background-color:rgba(255, 255, 255, 0);">查看server节点信息</font></h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# consul operator raft list-peers</span><br><span class="line">Node        ID                                    Address             State     Voter  RaftProtocol</span><br><span class="line">k8s-work1   322a522a-dcf5-3727-052e-0f2d65406f8d  192.168.10.11:8300  follower  true   3</span><br><span class="line">k8s-master  5db3c09a-f94d-b53f-6c9f-694beb64c1aa  192.168.10.10:8300  leader    true   3</span><br><span class="line">k8s-work2   d0e4a609-f029-cd91-1d61-63c3403b82b3  192.168.10.12:8300  follower  false  3</span><br></pre></td></tr></table></figure>

<h2 id="81ea3784"><font style="background-color:rgba(255, 255, 255, 0);">Consul常用HTTP API</font></h2>
<h2 id="3b842616"><font style="background-color:rgba(255, 255, 255, 0);">服务查询</font></h2>
+ <font style="background-color:rgba(255, 255, 255, 0);">/agent/services：该端点返回在本地代理程序中注册的所有服务；</font>
+ <font style="background-color:rgba(255, 255, 255, 0);">/agent/service/{service_id}：返回在本地代理上注册的单个服务实例的完整服务定义；</font>
+ <font style="background-color:rgba(255, 255, 255, 0);">/agent/health/service/name/{service_name} ：通过名称检索注册的服务状态（设置了健康检查的服务）；</font>
+ <font style="background-color:rgba(255, 255, 255, 0);">/agent/health/service/id/{service_id}：通过id检索注册的服务状态（设置了健康检查的服务）；</font>
+ <font style="background-color:rgba(255, 255, 255, 0);">/health/service/{service_name}?passing：通过健康检查的服务(包含未设置check的service)</font>

<h2 id="f3bad82b"><font style="background-color:rgba(255, 255, 255, 0);">服务注册</font></h2>
+ <font style="background-color:rgba(255, 255, 255, 0);">/agent/service/register：注册服务；</font>

<h2 id="18616023"><font style="background-color:rgba(255, 255, 255, 0);">服务删除</font></h2>
+ <font style="background-color:rgba(255, 255, 255, 0);">/agent/service/deregister/{service_id}：注销服务；</font>
+ <font style="background-color:rgba(255, 255, 255, 0);">/agent/service/maintenance/{service_id}：该端点将给定的服务置于“维护模式”，在维护模式下，该服务将被标记为不可用，并且不会出现在DNS或API查询中；</font>

<h1 id="f3bad82b-1"><font style="background-color:rgba(255, 255, 255, 0);">服务注册</font></h1>
---

<h2 id="15c64aa0"><font style="background-color:rgba(255, 255, 255, 0);">配置文件</font></h2>
<font style="background-color:rgba(255, 255, 255, 0);">新增json配置文件</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master consul.d]# cat /etc/consul.d/kube-apiserver.json </span><br><span class="line">&#123;</span><br><span class="line">    &quot;service&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;traefik-tcp&quot;,</span><br><span class="line">        &quot;tags&quot;: [</span><br><span class="line">            &quot;k8s&quot;,&quot;traefik&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;address&quot;: &quot;192.168.10.10&quot;,</span><br><span class="line">        &quot;port&quot;: 9100</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">重启服务</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master consul.d]# systemctl restart consul</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">web界面查看<br></font><img src="https://cdn.nlark.com/yuque/0/2025/jpeg/43141749/1738900841445-ed3d6655-6fda-49ac-88cb-19c119d5de0f.jpeg"></p>
<h2 id="http-api"><font style="background-color:rgba(255, 255, 255, 0);">HTTP API</font></h2>
<font style="background-color:rgba(255, 255, 255, 0);">注册一个name为traefik的服务</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master consul.d]# curl -X PUT -d &#x27;&#123;&quot;name&quot;: &quot;traefik&quot;,&quot;address&quot;: &quot;192.168.10.10&quot;,&quot;port&quot;: 80,&quot;tags&quot;: [&quot;k8s&quot;]&#125;&#x27; http://192.168.10.10:8500/v1/agent/service/register</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">注册带健康检查的服务</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT -d &#x27;&#123;&quot;name&quot;: &quot;traefik-metrics&quot;,&quot;address&quot;: &quot;192.168.10.10&quot;,&quot;port&quot;: 80,&quot;tags&quot;: [&quot;k8s&quot;],&quot;checks&quot;:[&#123;&quot;http&quot;:&quot;http://192.168.10.10:9100/metrics&quot;,&quot;interval&quot;:&quot;5s&quot;&#125;]&#125;&#x27; http://192.168.10.10:8500/v1/agent/service/register</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">打开管理页面查看已注册的服务<br></font><img src="https://cdn.nlark.com/yuque/0/2025/jpeg/43141749/1738900841454-78a08404-76de-44b8-8f10-689d9517273f.jpeg"></p>
<h2 id="sdk"><font style="background-color:rgba(255, 255, 255, 0);">SDK</font></h2>
<font style="background-color:rgba(255, 255, 255, 0);">除了采用配置文件或者HTTP API方式注册服务外，consul也支持使用sdk包注册查询服务，目前主流的开发语法均已支持，详情参考文档：  
</font>[<font style="background-color:rgba(255, 255, 255, 0);">https://developer.hashicorp.com/consul/api-docs/libraries-and-sdks</font>](https://developer.hashicorp.com/consul/api-docs/libraries-and-sdks)

<h1 id="3b842616-1"><font style="background-color:rgba(255, 255, 255, 0);">服务查询</font></h1>
---

<h2 id="http-api-1"><font style="background-color:rgba(255, 255, 255, 0);">HTTP API</font></h2>
<font style="background-color:rgba(255, 255, 255, 0);">查看服务列表</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# curl -s http://192.168.10.10:8500/v1/catalog/services | jq</span><br><span class="line">&#123;</span><br><span class="line">  &quot;consul&quot;: [],</span><br><span class="line">  &quot;traefik&quot;: [</span><br><span class="line">    &quot;k8s&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;traefik-tcp&quot;: [</span><br><span class="line">    &quot;k8s&quot;,</span><br><span class="line">    &quot;traefik&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">查看服务详细信息</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# curl -s http://192.168.10.10:8500/v1/catalog/service/traefik | jq</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;ID&quot;: &quot;eda0ef7f-ca12-bbca-c84e-f88cc3664cd1&quot;,</span><br><span class="line">    &quot;Node&quot;: &quot;tiaoban&quot;,</span><br><span class="line">    &quot;Address&quot;: &quot;192.168.10.100&quot;,</span><br><span class="line">    &quot;Datacenter&quot;: &quot;my-dc-1&quot;,</span><br><span class="line">    &quot;TaggedAddresses&quot;: &#123;</span><br><span class="line">      &quot;lan&quot;: &quot;192.168.10.100&quot;,</span><br><span class="line">      &quot;lan_ipv4&quot;: &quot;192.168.10.100&quot;,</span><br><span class="line">      &quot;wan&quot;: &quot;192.168.10.100&quot;,</span><br><span class="line">      &quot;wan_ipv4&quot;: &quot;192.168.10.100&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;NodeMeta&quot;: &#123;</span><br><span class="line">      &quot;consul-network-segment&quot;: &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ServiceKind&quot;: &quot;&quot;,</span><br><span class="line">    &quot;ServiceID&quot;: &quot;traefik&quot;,</span><br><span class="line">    &quot;ServiceName&quot;: &quot;traefik&quot;,</span><br><span class="line">    &quot;ServiceTags&quot;: [</span><br><span class="line">      &quot;k8s&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;ServiceAddress&quot;: &quot;192.168.10.10&quot;,</span><br><span class="line">    &quot;ServiceTaggedAddresses&quot;: &#123;</span><br><span class="line">      &quot;lan_ipv4&quot;: &#123;</span><br><span class="line">        &quot;Address&quot;: &quot;192.168.10.10&quot;,</span><br><span class="line">        &quot;Port&quot;: 80</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;wan_ipv4&quot;: &#123;</span><br><span class="line">        &quot;Address&quot;: &quot;192.168.10.10&quot;,</span><br><span class="line">        &quot;Port&quot;: 80</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ServiceWeights&quot;: &#123;</span><br><span class="line">      &quot;Passing&quot;: 1,</span><br><span class="line">      &quot;Warning&quot;: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ServiceMeta&quot;: &#123;&#125;,</span><br><span class="line">    &quot;ServicePort&quot;: 80,</span><br><span class="line">    &quot;ServiceSocketPath&quot;: &quot;&quot;,</span><br><span class="line">    &quot;ServiceEnableTagOverride&quot;: false,</span><br><span class="line">    &quot;ServiceProxy&quot;: &#123;</span><br><span class="line">      &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">      &quot;MeshGateway&quot;: &#123;&#125;,</span><br><span class="line">      &quot;Expose&quot;: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ServiceConnect&quot;: &#123;&#125;,</span><br><span class="line">    &quot;CreateIndex&quot;: 12,</span><br><span class="line">    &quot;ModifyIndex&quot;: 12</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">健康检查</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# curl -s http://192.168.10.10:8500/v1/health/service/traefik?passing | jq</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;Node&quot;: &#123;</span><br><span class="line">      &quot;ID&quot;: &quot;eda0ef7f-ca12-bbca-c84e-f88cc3664cd1&quot;,</span><br><span class="line">      &quot;Node&quot;: &quot;tiaoban&quot;,</span><br><span class="line">      &quot;Address&quot;: &quot;192.168.10.100&quot;,</span><br><span class="line">      &quot;Datacenter&quot;: &quot;my-dc-1&quot;,</span><br><span class="line">      &quot;TaggedAddresses&quot;: &#123;</span><br><span class="line">        &quot;lan&quot;: &quot;192.168.10.100&quot;,</span><br><span class="line">        &quot;lan_ipv4&quot;: &quot;192.168.10.100&quot;,</span><br><span class="line">        &quot;wan&quot;: &quot;192.168.10.100&quot;,</span><br><span class="line">        &quot;wan_ipv4&quot;: &quot;192.168.10.100&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;Meta&quot;: &#123;</span><br><span class="line">        &quot;consul-network-segment&quot;: &quot;&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;CreateIndex&quot;: 9,</span><br><span class="line">      &quot;ModifyIndex&quot;: 11</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;Service&quot;: &#123;</span><br><span class="line">      &quot;ID&quot;: &quot;traefik&quot;,</span><br><span class="line">      &quot;Service&quot;: &quot;traefik&quot;,</span><br><span class="line">      &quot;Tags&quot;: [</span><br><span class="line">        &quot;k8s&quot;</span><br><span class="line">      ],</span><br><span class="line">      &quot;Address&quot;: &quot;192.168.10.10&quot;,</span><br><span class="line">      &quot;TaggedAddresses&quot;: &#123;</span><br><span class="line">        &quot;lan_ipv4&quot;: &#123;</span><br><span class="line">          &quot;Address&quot;: &quot;192.168.10.10&quot;,</span><br><span class="line">          &quot;Port&quot;: 80</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;wan_ipv4&quot;: &#123;</span><br><span class="line">          &quot;Address&quot;: &quot;192.168.10.10&quot;,</span><br><span class="line">          &quot;Port&quot;: 80</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;Meta&quot;: null,</span><br><span class="line">      &quot;Port&quot;: 80,</span><br><span class="line">      &quot;Weights&quot;: &#123;</span><br><span class="line">        &quot;Passing&quot;: 1,</span><br><span class="line">        &quot;Warning&quot;: 1</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;EnableTagOverride&quot;: false,</span><br><span class="line">      &quot;Proxy&quot;: &#123;</span><br><span class="line">        &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">        &quot;MeshGateway&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Expose&quot;: &#123;&#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;Connect&quot;: &#123;&#125;,</span><br><span class="line">      &quot;PeerName&quot;: &quot;&quot;,</span><br><span class="line">      &quot;CreateIndex&quot;: 12,</span><br><span class="line">      &quot;ModifyIndex&quot;: 12</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;Checks&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;Node&quot;: &quot;tiaoban&quot;,</span><br><span class="line">        &quot;CheckID&quot;: &quot;serfHealth&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;Serf Health Status&quot;,</span><br><span class="line">        &quot;Status&quot;: &quot;passing&quot;,</span><br><span class="line">        &quot;Notes&quot;: &quot;&quot;,</span><br><span class="line">        &quot;Output&quot;: &quot;Agent alive and reachable&quot;,</span><br><span class="line">        &quot;ServiceID&quot;: &quot;&quot;,</span><br><span class="line">        &quot;ServiceName&quot;: &quot;&quot;,</span><br><span class="line">        &quot;ServiceTags&quot;: [],</span><br><span class="line">        &quot;Type&quot;: &quot;&quot;,</span><br><span class="line">        &quot;Interval&quot;: &quot;&quot;,</span><br><span class="line">        &quot;Timeout&quot;: &quot;&quot;,</span><br><span class="line">        &quot;ExposedPort&quot;: 0,</span><br><span class="line">        &quot;Definition&quot;: &#123;&#125;,</span><br><span class="line">        &quot;CreateIndex&quot;: 9,</span><br><span class="line">        &quot;ModifyIndex&quot;: 9</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">删除注册的服务</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master consul.d]# curl -X PUT http://192.168.10.10:8500/v1/agent/service/deregister/traefik</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<h2 id="74c3df45"><font style="background-color:rgba(255, 255, 255, 0);">DNS解析</font></h2>
<font style="background-color:rgba(255, 255, 255, 0);">DNS接口是Consul中主要的查询接口之一，另一个是HTTP接口， HTTP接口查询请查阅,Consul默认在8600端口监听DNS查询。  
</font><font style="background-color:rgba(255, 255, 255, 0);">参考文档：</font>[<font style="background-color:rgba(255, 255, 255, 0);">https://developer.hashicorp.com/consul/docs/discovery/dns</font>](https://developer.hashicorp.com/consul/docs/discovery/dns)<font style="background-color:rgba(255, 255, 255, 0);">  
</font><font style="background-color:rgba(255, 255, 255, 0);">要使用DNS接口， 有几种方法可以实现：  
</font><font style="background-color:rgba(255, 255, 255, 0);">一是使用指定的DNS解析库， 然后指向Consul；  
</font><font style="background-color:rgba(255, 255, 255, 0);">二是把Consul设置为节点的DNS服务器, 并且提供recursors配置项， 这样非Consul的查询也能被解析；  
</font><font style="background-color:rgba(255, 255, 255, 0);">最后一种方法是从已有的DNS服务器上把所有consul.为域名的请求转发到consul agent上。  
</font>**<font style="background-color:rgba(255, 255, 255, 0);">节点查找</font>**<font style="background-color:rgba(255, 255, 255, 0);">  
</font><font style="background-color:rgba(255, 255, 255, 0);">查找节点的地址信息，查找格式：<node>.node[.datacenter].<domain>。如果datacenter不指定，默认为当前集群查询。</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# dig @192.168.10.10 -p 8600 tiaoban.node.consul ANY</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.26-RedHat-9.11.26-6.el8 &lt;&lt;&gt;&gt; @192.168.10.10 -p 8600 tiaoban.node.consul ANY</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 25684</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;tiaoban.node.consul.           IN      ANY</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">tiaoban.node.consul.    0       IN      A       192.168.10.100</span><br><span class="line">tiaoban.node.consul.    0       IN      TXT     &quot;consul-network-segment=&quot;</span><br><span class="line"></span><br><span class="line">;; Query time: 14 msec</span><br><span class="line">;; SERVER: 192.168.10.10#8600(192.168.10.10)</span><br><span class="line">;; WHEN: 一 10月 31 10:51:10 CST 2022</span><br><span class="line">;; MSG SIZE  rcvd: 100</span><br></pre></td></tr></table></figure>

<p><strong><font style="background-color:rgba(255, 255, 255, 0);">服务查找</font></strong><font style="background-color:rgba(255, 255, 255, 0);"><br></font><font style="background-color:rgba(255, 255, 255, 0);">查询服务提供者。服务查询支持两种查找方法：标准和严格RFC 2782。<br></font><font style="background-color:rgba(255, 255, 255, 0);">标准查找格式：[tag.]<service>.service[.datacenter].<domain>。Tag是可选的，而且与节点查找一样，数据中心也是可选。如果没有提供Tag，就不会有过滤，如果没有数据中心，就会选择默认的数据中心。</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# dig @192.168.10.10 -p 8600 traefik.service.consul SRV</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.26-RedHat-9.11.26-6.el8 &lt;&lt;&gt;&gt; @192.168.10.10 -p 8600 traefik.service.consul SRV</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 28200</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 3</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;traefik.service.consul.                IN      SRV</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">traefik.service.consul. 0       IN      SRV     1 1 80 c0a80a0a.addr.my-dc-1.consul.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">c0a80a0a.addr.my-dc-1.consul. 0 IN      A       192.168.10.10</span><br><span class="line">tiaoban.node.my-dc-1.consul. 0  IN      TXT     &quot;consul-network-segment=&quot;</span><br><span class="line"></span><br><span class="line">;; Query time: 13 msec</span><br><span class="line">;; SERVER: 192.168.10.10#8600(192.168.10.10)</span><br><span class="line">;; WHEN: 一 10月 31 10:53:30 CST 2022</span><br><span class="line">;; MSG SIZE  rcvd: 164</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">RFC2782 查找 格式：</font><em><font style="background-color:rgba(255, 255, 255, 0);"><service>.</font></em><font style="background-color:rgba(255, 255, 255, 0);"><protocol>.service[.datacenter][.domain]根据RFC 2782， SRV请求都应该在service和protocol前使用(_)作为前缀。避免发生DNS冲突。Protocol可以是service任何一个tag，如果service没有tag，使用tcp作为protocol。如果一旦设置了tcp，那么查询时将不会执行任何标签过滤。</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 查询tag为k8s的注册服务traefik信息。</span><br><span class="line">[root@k8s-master ~]# dig @192.168.10.10 -p 8600 _traefik._k8s.service.consul SRV</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.26-RedHat-9.11.26-6.el8 &lt;&lt;&gt;&gt; @192.168.10.10 -p 8600 _traefik._k8s.service.consul SRV</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 43270</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 3</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;_traefik._k8s.service.consul.  IN      SRV</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">_traefik._k8s.service.consul. 0 IN      SRV     1 1 80 c0a80a0a.addr.my-dc-1.consul.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">c0a80a0a.addr.my-dc-1.consul. 0 IN      A       192.168.10.10</span><br><span class="line">tiaoban.node.my-dc-1.consul. 0  IN      TXT     &quot;consul-network-segment=&quot;</span><br><span class="line"></span><br><span class="line">;; Query time: 1 msec</span><br><span class="line">;; SERVER: 192.168.10.10#8600(192.168.10.10)</span><br><span class="line">;; WHEN: 一 10月 31 10:57:05 CST 2022</span><br><span class="line">;; MSG SIZE  rcvd: 170</span><br></pre></td></tr></table></figure>

<h1 id="bf9a8ea1"><font style="background-color:rgba(255, 255, 255, 0);">配置kv</font></h1>
---

<p><font style="background-color:rgba(255, 255, 255, 0);">consul kv 是consul的核心功能，并随consul agent一起安装。consul kv允许用户存储索引对象，尽管其主要用途是存储配置参数和元数据。<br></font><font style="background-color:rgba(255, 255, 255, 0);">consul kv 数据存储在server上，可以由任何agent（client或server）访问。consul允许在所有server之间自动复制数据，如果发生故障，拥有一定数量的server将减少数据丢失的风险。<br></font><font style="background-color:rgba(255, 255, 255, 0);">数据存储位于server上的数据目录中，为确保在完全中断的情况下不会丢失数据，可以使用 consul snapshot 命令备份数据。还可以通过 consul kv 子命令、HTTP API 和 Consul UI 访问kv存储。</font></p>
<h2 id="dbb0d3bb"><font style="background-color:rgba(255, 255, 255, 0);">命令行</font></h2>
<font style="background-color:rgba(255, 255, 255, 0);">命令行创建kv</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master consul.d]# consul kv put key1 value1</span><br><span class="line">Success! Data written to: key1</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">查看kv</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 查看所有key value数据</span><br><span class="line">[root@k8s-master consul.d]# consul kv get --recurse </span><br><span class="line">key1:value1</span><br><span class="line">key2:value2</span><br><span class="line"># 查看指定key value数据</span><br><span class="line">[root@k8s-master consul.d]# consul kv get key2</span><br><span class="line">value2</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">更新kv</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master consul.d]# consul kv put key2 v2</span><br><span class="line">Success! Data written to: key2</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">删除kv</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master consul.d]# consul kv delete key2</span><br><span class="line">Success! Deleted key: key2</span><br></pre></td></tr></table></figure>

<h2 id="web"><font style="background-color:rgba(255, 255, 255, 0);">web</font></h2>
<font style="background-color:rgba(255, 255, 255, 0);">web界面创建kv  
</font>![](https://cdn.nlark.com/yuque/0/2025/jpeg/43141749/1738900841944-ff641b3f-de5b-4382-b961-1c30bf857d1b.jpeg)<font style="background-color:rgba(255, 255, 255, 0);">  
</font><font style="background-color:rgba(255, 255, 255, 0);">web界面查看kv  
</font>![](https://cdn.nlark.com/yuque/0/2025/jpeg/43141749/1738900842227-005c67d9-9bd2-4a02-9f36-e4e9aa288c32.jpeg)

<h2 id="http-api-2"><font style="background-color:rgba(255, 255, 255, 0);">HTTP API</font></h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 设置kv</span><br><span class="line">[root@k8s-master consul.d]# curl -X PUT -d &#x27;value3&#x27; http://192.168.10.10:8500/v1/kv/key3</span><br><span class="line">true</span><br><span class="line"># 查看kv</span><br><span class="line">[root@k8s-master consul.d]# curl -s http://192.168.10.10:8500/v1/kv/key3 | jq</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;LockIndex&quot;: 0,</span><br><span class="line">    &quot;Key&quot;: &quot;key3&quot;,</span><br><span class="line">    &quot;Flags&quot;: 0,</span><br><span class="line">    &quot;Value&quot;: &quot;dmFsdWUz&quot;,</span><br><span class="line">    &quot;CreateIndex&quot;: 611,</span><br><span class="line">    &quot;ModifyIndex&quot;: 611</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"># base64解码查看内容</span><br><span class="line">[root@k8s-master consul.d]# echo &quot;dmFsdWUz&quot; | base64 -d</span><br><span class="line">value3</span><br><span class="line"># 删除kv</span><br><span class="line">[root@k8s-master consul.d]# curl -X DELETE http://192.168.10.10:8500/v1/kv/key3</span><br></pre></td></tr></table></figure>

<h1 id="f58e1c18"><font style="background-color:rgba(255, 255, 255, 0);">访问控制</font></h1>
---

<p><font style="background-color:rgba(255, 255, 255, 0);">通过ACLS 来确保安全的访问 UI, API, CLI, servie 通信，Agent通信。如果想要确保数据中心安全，就需要配置ACLS。ACL核心原理是，将规则分组为策略， 然后一个或多个策略于令牌关联。</font></p>
<h2 id="8facd89c"><font style="background-color:rgba(255, 255, 255, 0);">启用ACL</font></h2>
<font style="background-color:rgba(255, 255, 255, 0);">修改consul配置文件，新增如下内容</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># acl访问控制</span><br><span class="line">acl = &#123;</span><br><span class="line">  enabled = true</span><br><span class="line">  default_policy = &quot;deny&quot; # 默认拒绝所有操作</span><br><span class="line">  enable_token_persistence = true # 持久化到磁盘，重启时重新加载</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">重启consul服务</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master consul.d]# systemctl restart consul</span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);"></font></p>
<p><font style="background-color:rgba(255, 255, 255, 0);">生成token</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master consul.d]# consul acl bootstrap</span><br><span class="line">AccessorID:       16a37577-f243-94fb-8770-35489870025c</span><br><span class="line">SecretID:         54a3e3fd-ea07-85a8-67e3-33107a958977</span><br><span class="line">Description:      Bootstrap Token (Global Management)</span><br><span class="line">Local:            false</span><br><span class="line">Create Time:      2022-10-27 22:56:07.654230262 +0800 CST</span><br><span class="line">Policies:</span><br><span class="line">   00000000-0000-0000-0000-000000000001 - global-management</span><br></pre></td></tr></table></figure>

<h2 id="046e223e"><font style="background-color:rgba(255, 255, 255, 0);">访问验证</font></h2>
<font style="background-color:rgba(255, 255, 255, 0);">web页面访问验证  
</font>![](https://cdn.nlark.com/yuque/0/2025/jpeg/43141749/1738900842237-eb42da7b-f34d-499d-9861-dd3bb7290224.jpeg)<font style="background-color:rgba(255, 255, 255, 0);">  
</font><font style="background-color:rgba(255, 255, 255, 0);">api接口访问验证</font>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 直接获取kv提示权限拒绝</span><br><span class="line">[root@k8s-master consul.d]# curl -s http://192.168.10.10:8500/v1/kv/key3 </span><br><span class="line">rpc error making call: Permission denied: token with AccessorID &#x27;00000000-0000-0000-0000-000000000002&#x27; lacks permission &#x27;key:read&#x27; on &quot;key3&quot;[root@k8s-master consul.d]# </span><br><span class="line"># 请求头添加token访问</span><br><span class="line">[root@k8s-master consul.d]# curl -s -H &quot;X-Consul-Token:54a3e3fd-ea07-85a8-67e3-33107a958977&quot; http://192.168.10.10:8500/v1/kv/key3 | jq</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;LockIndex&quot;: 0,</span><br><span class="line">    &quot;Key&quot;: &quot;key3&quot;,</span><br><span class="line">    &quot;Flags&quot;: 0,</span><br><span class="line">    &quot;Value&quot;: &quot;dmFsdWUz&quot;,</span><br><span class="line">    &quot;CreateIndex&quot;: 611,</span><br><span class="line">    &quot;ModifyIndex&quot;: 611</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://www.xiaoxi.ink">小熙</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://www.xiaoxi.ink/2025/03/08/%E5%85%A5%E9%97%A8%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E2%80%94%E2%80%94consul%20%E5%89%AF%E6%9C%AC/">https://www.xiaoxi.ink/2025/03/08/%E5%85%A5%E9%97%A8%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E2%80%94%E2%80%94consul%20%E5%89%AF%E6%9C%AC/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/03/08/Istio/" title="Istio--安装部署"><img class="cover" src="/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg" onerror="onerror=null;src='/img/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Istio--安装部署</div></div><div class="info-2"><div class="info-item-1">Istio 简介 Connect, secure, control, and observe services.  连接、安全加固、控制和观察服务的开放平台。  连接（Connect）：智能控制服务之间的调用流量，能够实现灰度升级、AB 测试和红黑部署等功能； 安全加固（Secure）：自动为服务之间的调用提供认证、授权和加密； 控制（Control）：应用用户定义的 policy，保证资源在消费者中公平分配； 观察（Observe）：查看服务运行期间的各种数据，比如日志、监控和 tracing，了解服务的运行情况。  Service Mesh `Service Mesh`(服务网格)可以简单理解为**"分布式代理"**.   Istio 架构 ![](https://cdn.nlark.com/yuque/0/2025/svg/43141749/1741444377049-daa84c0b-0834-4f07-9510-5202b4a8617a.svg)  Istio 安装部署 使用`istioctl`安装 官方详细中文安装文档:...</div></div></div></a><a class="pagination-related" href="/2025/03/11/1.kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="kubeadm高可用部署"><img class="cover" src="/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg" onerror="onerror=null;src='/img/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">kubeadm高可用部署</div></div><div class="info-2"><div class="info-item-1">高可用架构方案 ---  高可用架构说明 ---     核心组件 高可用模式 高可用实现方式    apiserver 主备 keepalived   controller-manager 主备 leader election   scheduler 主备 leader election   etcd 集群 kubeadm    apiserver 通过haproxy+keepalived实现高可用，当某个节点故障时触发keepalived vip 转移； controller-manager k8s内部通过选举方式产生领导者(由–leader-elect 选型控制，默认为true)，同一时刻集群内只有一个controller-manager组件运行； scheduler k8s内部通过选举方式产生领导者(由–leader-elect 选型控制，默认为true)，同一时刻集群内只有一个scheduler组件运行； etcd...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/%E5%A4%B4%E5%83%8F.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">小熙</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/jack-xi-jack"><i class="fab fa-github"></i><span>🛴前往小家...</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/jack-xi-jack" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:1643699428@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="/wechat-qr.html" target="_blank" title="微信"><i class="fab fa-weixin" style="color: #000000;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">小熙的技术博客</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#8519e085"><span class="toc-number">1.</span> <span class="toc-text">基础概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5e372583"><span class="toc-number">1.1.</span> <span class="toc-text">什么是注册中心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9cfc6012"><span class="toc-number">1.2.</span> <span class="toc-text">什么是Consul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22750ec8"><span class="toc-number">1.3.</span> <span class="toc-text">Consul特点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#73539e88"><span class="toc-number">1.4.</span> <span class="toc-text">consul组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#641185e8"><span class="toc-number">1.5.</span> <span class="toc-text">Consul 架构图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#236bb442"><span class="toc-number">1.6.</span> <span class="toc-text">Consul的使用场景</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#039d392c"><span class="toc-number">2.</span> <span class="toc-text">安装部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#62a5d2da"><span class="toc-number">2.1.</span> <span class="toc-text">yum部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4443f491"><span class="toc-number">2.2.</span> <span class="toc-text">二进制部署</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#b19ba4ef"><span class="toc-number">3.</span> <span class="toc-text">服务启动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8c7054cf"><span class="toc-number">3.1.</span> <span class="toc-text">单节点模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6955953a"><span class="toc-number">3.2.</span> <span class="toc-text">集群模式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4b194b09"><span class="toc-number">4.</span> <span class="toc-text">Consul 常用CLI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#eb75b9f5"><span class="toc-number">4.1.</span> <span class="toc-text">查看服务列表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#75acbd2e"><span class="toc-number">4.2.</span> <span class="toc-text">注销服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1b4e985d"><span class="toc-number">4.3.</span> <span class="toc-text">查看节点成员</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1459fae8"><span class="toc-number">4.4.</span> <span class="toc-text">查看server节点信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#81ea3784"><span class="toc-number">4.5.</span> <span class="toc-text">Consul常用HTTP API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3b842616"><span class="toc-number">4.6.</span> <span class="toc-text">服务查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#f3bad82b"><span class="toc-number">4.7.</span> <span class="toc-text">服务注册</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18616023"><span class="toc-number">4.8.</span> <span class="toc-text">服务删除</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#f3bad82b-1"><span class="toc-number">5.</span> <span class="toc-text">服务注册</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#15c64aa0"><span class="toc-number">5.1.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http-api"><span class="toc-number">5.2.</span> <span class="toc-text">HTTP API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sdk"><span class="toc-number">5.3.</span> <span class="toc-text">SDK</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3b842616-1"><span class="toc-number">6.</span> <span class="toc-text">服务查询</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#http-api-1"><span class="toc-number">6.1.</span> <span class="toc-text">HTTP API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#74c3df45"><span class="toc-number">6.2.</span> <span class="toc-text">DNS解析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#bf9a8ea1"><span class="toc-number">7.</span> <span class="toc-text">配置kv</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dbb0d3bb"><span class="toc-number">7.1.</span> <span class="toc-text">命令行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#web"><span class="toc-number">7.2.</span> <span class="toc-text">web</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http-api-2"><span class="toc-number">7.3.</span> <span class="toc-text">HTTP API</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#f58e1c18"><span class="toc-number">8.</span> <span class="toc-text">访问控制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8facd89c"><span class="toc-number">8.1.</span> <span class="toc-text">启用ACL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#046e223e"><span class="toc-number">8.2.</span> <span class="toc-text">访问验证</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/03/31/hello-world/" title="Hello World"><img src="/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg" onerror="this.onerror=null;this.src='/img/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg'" alt="Hello World"/></a><div class="content"><a class="title" href="/2025/03/31/hello-world/" title="Hello World">Hello World</a><time datetime="2025-03-30T16:06:56.220Z" title="Created 2025-03-31 00:06:56">2025-03-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/17/1.%E5%AD%98%E5%82%A8%E5%9F%BA%E7%A1%80%20%E5%89%AF%E6%9C%AC/" title="存储基础"><img src="/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg" onerror="this.onerror=null;this.src='/img/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg'" alt="存储基础"/></a><div class="content"><a class="title" href="/2025/03/17/1.%E5%AD%98%E5%82%A8%E5%9F%BA%E7%A1%80%20%E5%89%AF%E6%9C%AC/" title="存储基础">存储基础</a><time datetime="2025-03-17T11:30:00.000Z" title="Created 2025-03-17 19:30:00">2025-03-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/17/2.%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%20%E5%89%AF%E6%9C%AC/" title="分布式存储"><img src="/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg" onerror="this.onerror=null;this.src='/img/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg'" alt="分布式存储"/></a><div class="content"><a class="title" href="/2025/03/17/2.%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%20%E5%89%AF%E6%9C%AC/" title="分布式存储">分布式存储</a><time datetime="2025-03-17T11:30:00.000Z" title="Created 2025-03-17 19:30:00">2025-03-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/17/3.%E5%AD%98%E5%82%A8%E7%B1%BB%E5%9E%8B%20%E5%89%AF%E6%9C%AC/" title="存储类型"><img src="/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg" onerror="this.onerror=null;this.src='/img/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg'" alt="存储类型"/></a><div class="content"><a class="title" href="/2025/03/17/3.%E5%AD%98%E5%82%A8%E7%B1%BB%E5%9E%8B%20%E5%89%AF%E6%9C%AC/" title="存储类型">存储类型</a><time datetime="2025-03-17T10:00:00.000Z" title="Created 2025-03-17 18:00:00">2025-03-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/11/1.kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="kubeadm高可用部署"><img src="/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg" onerror="this.onerror=null;this.src='/img/%E5%B0%8F%E5%B1%81%E8%82%A1.jpg'" alt="kubeadm高可用部署"/></a><div class="content"><a class="title" href="/2025/03/11/1.kubeadm%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="kubeadm高可用部署">kubeadm高可用部署</a><time datetime="2025-03-11T10:00:00.000Z" title="Created 2025-03-11 18:00:00">2025-03-11</time></div></div></div></div></div></div></main><footer id="footer" style="background: 小屁股.jpg;"><div id="footer-wrap"><div class="copyright">&copy;2025 By 小熙</div><div class="footer_custom_text">I wish you to become your own sun, no need to rely on who's light.<p><a target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://butterfly.js.org/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://www.jsdelivr.com/"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用JsDelivr为静态资源提供CDN加速"></a> &nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="本站采用双线部署，默认线路托管于Vercel"></a>&nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Coding-0cedbe?style=flat&logo=Codio" title="本站采用双线部署，联通线路托管于Coding"></a>&nbsp;<a target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp;<a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script src="xxxx"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      const usePjax = true
      true 
        ? (usePjax ? pjax.loadUrl('/404.html') : window.location.href = '/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>